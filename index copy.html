<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>MATRIX :: CONSOLE</title>

        <style>
            :root {
                --bg: #0b0e14;
                --text: #d7dde8;
                --muted: #8b93a7;

                /* ANSI sutis */
                --cyan: #58c7d7;
                --blue: #6aa6ff;
                --gray: #9aa3b5;

                --good: #73e6c7;
                --warn: #ffcf5a;
                --bad: #ff6b86;

                --line: #1d2940;
                --line2: #142033;

                --mono:
                    ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
                    "Liberation Mono", monospace;
                --sans:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Helvetica, Arial, sans-serif;

                --sel: rgba(106, 166, 255, 0.16);
                --selBorder: rgba(106, 166, 255, 0.45);
                --selGlow: rgba(106, 166, 255, 0.2);

                --tagBg: rgba(255, 255, 255, 0.04);
                --tagBd: rgba(255, 255, 255, 0.09);

                --btnBg: rgba(88, 199, 215, 0.12);
                --btnBd: rgba(88, 199, 215, 0.26);
                --btnBg2: rgba(106, 166, 255, 0.12);
                --btnBd2: rgba(106, 166, 255, 0.26);

                --chipBg: rgba(255, 255, 255, 0.03);
                --chipBd: rgba(255, 255, 255, 0.1);
                --chipOn: rgba(115, 230, 199, 0.12);
                --chipOnBd: rgba(115, 230, 199, 0.28);
            }

            * {
                box-sizing: border-box;
            }
            html,
            body {
                height: 100%;
            }
            body {
                margin: 0;
                background: radial-gradient(
                    1200px 600px at 20% 0%,
                    #0f1626 0%,
                    var(--bg) 60%
                );
                color: var(--text);
                font-family: var(--mono);
                letter-spacing: 0.2px;
            }

            .wrap {
                max-width: 1100px;
                margin: 28px auto 110px;
                padding: 0 18px;
            }

            /* Header */
            .header-box {
                border: 1px solid var(--line);
                border-radius: 12px;
                background: linear-gradient(
                    180deg,
                    rgba(255, 255, 255, 0.03),
                    rgba(255, 255, 255, 0.01)
                );
                padding: 14px 16px;
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
            }

            .header-top {
                display: flex;
                gap: 12px;
                align-items: center;
                justify-content: space-between;
                flex-wrap: wrap;
            }

            .brand {
                display: flex;
                align-items: baseline;
                gap: 10px;
                min-width: 260px;
            }
            .brand .title {
                font-weight: 700;
                color: var(--cyan);
                font-size: 14px;
                letter-spacing: 1.2px;
            }
            .brand .subtitle {
                color: var(--muted);
                font-size: 12px;
                font-family: var(--sans);
            }

            .statusline {
                display: flex;
                gap: 14px;
                flex-wrap: wrap;
                font-size: 12px;
                color: var(--gray);
            }
            .pill {
                border: 1px solid var(--line2);
                background: rgba(88, 199, 215, 0.06);
                padding: 6px 10px;
                border-radius: 999px;
                display: flex;
                gap: 6px;
                align-items: center;
            }
            .pill b {
                color: var(--text);
                font-weight: 600;
            }
            .dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--good);
                box-shadow: 0 0 12px rgba(115, 230, 199, 0.35);
            }

            .controls {
                margin-top: 12px;
                display: flex;
                gap: 12px;
                flex-wrap: wrap;
                align-items: center;
            }
            .control {
                display: flex;
                gap: 8px;
                align-items: center;
                border: 1px solid var(--line2);
                background: rgba(255, 255, 255, 0.02);
                border-radius: 10px;
                padding: 10px 12px;
                flex: 1 1 320px;
                min-width: 240px;
            }
            .control label {
                color: var(--muted);
                font-size: 12px;
                font-family: var(--sans);
                white-space: nowrap;
            }
            .control input[type="text"] {
                width: 100%;
                background: transparent;
                border: none;
                outline: none;
                color: var(--text);
                font-family: var(--mono);
                font-size: 13px;
            }

            .toggles {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                align-items: center;
                justify-content: flex-end;
                flex: 0 0 auto;
            }
            .chip {
                user-select: none;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 10px 12px;
                border-radius: 999px;
                border: 1px solid var(--chipBd);
                background: var(--chipBg);
                color: rgba(215, 221, 232, 0.9);
                font-family: var(--sans);
                font-weight: 600;
                font-size: 12px;
                letter-spacing: 0.2px;
                transition:
                    background 0.12s ease,
                    border-color 0.12s ease,
                    transform 0.06s ease;
                white-space: nowrap;
            }
            .chip:active {
                transform: translateY(1px);
            }
            .chip.on {
                border-color: var(--chipOnBd);
                background: var(--chipOn);
                color: rgba(215, 221, 232, 0.98);
            }
            .chip small {
                color: var(--muted);
                font-weight: 500;
            }
            .chip.on small {
                color: rgba(180, 240, 248, 0.95);
            }

            /* Dashboard layout */
            .dash {
                margin-top: 18px;
                display: grid;
                grid-template-columns: 1.12fr 0.88fr;
                gap: 16px;
            }
            @media (max-width: 860px) {
                .dash {
                    grid-template-columns: 1fr;
                }
                .toggles {
                    justify-content: flex-start;
                }
            }

            .panel {
                border: 1px solid var(--line);
                border-radius: 12px;
                background: rgba(15, 21, 33, 0.65);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.28);
                overflow: hidden;
            }
            .panel .panel-head {
                padding: 12px 14px;
                border-bottom: 1px solid var(--line2);
                background: rgba(12, 17, 27, 0.7);
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 10px;
            }
            .panel .panel-head .h {
                color: var(--cyan);
                font-weight: 700;
                letter-spacing: 0.8px;
                font-size: 13px;
            }
            .panel .panel-head .meta {
                color: var(--muted);
                font-size: 12px;
                font-family: var(--sans);
            }

            .section {
                padding: 10px 14px 14px;
            }
            .section + .section {
                border-top: 1px dashed rgba(29, 41, 64, 0.7);
                padding-top: 12px;
            }
            .section-title {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 10px;
                margin: 2px 0 10px;
            }
            .section-title .t {
                color: var(--blue);
                font-weight: 700;
                font-size: 13px;
                letter-spacing: 0.6px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .section-title .count {
                color: var(--muted);
                font-size: 12px;
                font-family: var(--sans);
            }

            /* rows */
            .rows {
                display: flex;
                flex-direction: column;
                gap: 6px;
            }
            .row {
                user-select: none;
                cursor: pointer;
                display: grid;
                grid-template-columns: 78px 1fr;
                gap: 12px;
                align-items: baseline;
                padding: 9px 10px;
                border-radius: 10px;
                border: 1px solid transparent;
                background: rgba(255, 255, 255, 0.01);
                transition:
                    background 0.12s ease,
                    border-color 0.12s ease,
                    box-shadow 0.12s ease;
            }
            .row:hover {
                border-color: rgba(106, 166, 255, 0.25);
                background: rgba(106, 166, 255, 0.06);
            }
            .row.selected {
                border-color: var(--selBorder);
                background: var(--sel);
                box-shadow:
                    0 0 0 1px rgba(106, 166, 255, 0.15) inset,
                    0 0 22px var(--selGlow);
            }
            .id {
                color: var(--gray);
                font-weight: 700;
                letter-spacing: 0.4px;
            }
            .name {
                color: var(--text);
                font-family: var(--sans);
                font-size: 13px;
                line-height: 1.25;
            }

            .badge {
                display: inline-flex;
                gap: 6px;
                align-items: center;
                font-size: 11px;
                font-family: var(--sans);
                color: rgba(215, 221, 232, 0.9);
                border: 1px solid rgba(255, 255, 255, 0.08);
                background: rgba(255, 255, 255, 0.03);
                padding: 3px 8px;
                border-radius: 999px;
                margin-left: 8px;
                vertical-align: middle;
                white-space: nowrap;
            }
            .badge.c {
                border-color: rgba(88, 199, 215, 0.2);
                background: rgba(88, 199, 215, 0.1);
                color: rgba(180, 240, 248, 0.95);
            }

            .hint {
                margin-top: 10px;
                color: var(--muted);
                font-family: var(--sans);
                font-size: 12px;
            }

            /* Action bar */
            .actionbar {
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
                padding: 12px 14px;
                background: rgba(10, 14, 20, 0.82);
                backdrop-filter: blur(10px);
                border-top: 1px solid rgba(29, 41, 64, 0.65);
                box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.35);
            }
            .actionbar-inner {
                max-width: 1100px;
                margin: 0 auto;
                display: flex;
                gap: 12px;
                align-items: center;
                justify-content: space-between;
                flex-wrap: wrap;
                padding: 0 8px;
            }

            .summary {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                align-items: center;
                font-family: var(--sans);
                font-size: 12px;
                color: var(--muted);
            }
            .tag {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                border: 1px solid var(--tagBd);
                background: var(--tagBg);
                color: rgba(215, 221, 232, 0.95);
                padding: 6px 10px;
                border-radius: 999px;
                font-family: var(--mono);
                font-size: 12px;
                letter-spacing: 0.1px;
                white-space: nowrap;
            }
            .tag .k {
                color: var(--gray);
                font-weight: 700;
            }
            .tag .v {
                color: var(--text);
                font-weight: 600;
            }

            .btns {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                align-items: center;
            }
            .btn {
                cursor: pointer;
                border-radius: 12px;
                padding: 10px 12px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                background: rgba(255, 255, 255, 0.04);
                color: var(--text);
                font-family: var(--sans);
                font-weight: 600;
                font-size: 13px;
                letter-spacing: 0.2px;
                display: inline-flex;
                align-items: center;
                gap: 8px;
                transition:
                    transform 0.06s ease,
                    background 0.12s ease,
                    border-color 0.12s ease;
            }
            .btn:active {
                transform: translateY(1px);
            }
            .btn.primary {
                border-color: var(--btnBd2);
                background: var(--btnBg2);
            }
            .btn.secondary {
                border-color: var(--btnBd);
                background: var(--btnBg);
            }
            .btn:disabled {
                cursor: not-allowed;
                opacity: 0.45;
            }

            .toast {
                position: fixed;
                right: 14px;
                bottom: 88px;
                max-width: 420px;
                border: 1px solid rgba(29, 41, 64, 0.75);
                background: rgba(15, 21, 33, 0.88);
                border-radius: 12px;
                padding: 10px 12px;
                color: rgba(215, 221, 232, 0.95);
                font-family: var(--sans);
                font-size: 12px;
                box-shadow: 0 14px 40px rgba(0, 0, 0, 0.45);
                display: none;
            }
            .toast b {
                color: var(--good);
            }

            /* Loading / error */
            .msg {
                margin-top: 16px;
                border: 1px solid var(--line);
                border-radius: 12px;
                padding: 14px 16px;
                background: rgba(15, 21, 33, 0.5);
                font-family: var(--sans);
                color: var(--muted);
            }
            .msg b {
                color: var(--text);
            }
            .msg.error {
                border-color: rgba(255, 107, 134, 0.25);
            }
            .msg.error b {
                color: var(--bad);
            }
        </style>
    </head>

    <body>
        <div class="wrap">
            <div class="header-box">
                <div class="header-top">
                    <div class="brand">
                        <div class="title">MATRIX :: CONSOLE</div>
                        <div class="subtitle">
                            selecione ¬∑ gere ¬∑ copie ¬∑ cole no Gemini
                        </div>
                    </div>

                    <div class="statusline">
                        <div class="pill">
                            <span class="dot"></span> <span>STATUS:</span>
                            <b id="status">LOADING</b>
                        </div>
                        <div class="pill">
                            <span>MODE:</span> <b id="mode">SELECTOR</b>
                        </div>
                        <div class="pill">
                            <span>VERSION:</span> <b id="version">web-2.1</b>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <div class="control">
                        <label for="filter">Filtro</label>
                        <input
                            id="filter"
                            type="text"
                            autocomplete="off"
                            placeholder="Filtrar (ex.: U-03, S-11, Manu, Jonas, Noir‚Ä¶)"
                        />
                    </div>

                    <div class="toggles">
                        <div
                            class="chip"
                            id="chipCinematic"
                            role="button"
                            aria-pressed="false"
                            tabindex="0"
                        >
                            üé¨ Modo cinematic <small>(off)</small>
                        </div>
                        <div
                            class="chip"
                            id="chipColdOpen"
                            role="button"
                            aria-pressed="false"
                            tabindex="0"
                        >
                            ‚ö° Cold open <small>(off)</small>
                        </div>
                    </div>
                </div>
            </div>

            <div id="message" class="msg" style="display: none"></div>

            <div class="dash" id="dash" style="display: none">
                <!-- LEFT -->
                <div class="panel">
                    <div class="panel-head">
                        <div class="h">üåå UNIVERSOS + üìç ESPA√áOS</div>
                        <div class="meta">selecione 1 (universo OU espa√ßo)</div>
                    </div>

                    <div class="section">
                        <div class="section-title">
                            <div class="t">üåå UNIVERSOS</div>
                            <div class="count" id="uCount"></div>
                        </div>
                        <div class="rows" id="universes"></div>
                    </div>

                    <div class="section">
                        <div class="section-title">
                            <div class="t">üìç ESPA√áOS</div>
                            <div class="count" id="sCount"></div>
                        </div>
                        <div class="rows" id="spaces"></div>
                        <div
                            class="hint"
                            id="clusterHint"
                            style="display: none"
                        ></div>
                    </div>
                </div>

                <!-- RIGHT -->
                <div class="panel">
                    <div class="panel-head">
                        <div class="h">üë§ ATIVOS</div>
                        <div class="meta">selecione quantos quiser</div>
                    </div>

                    <div class="section">
                        <div class="section-title">
                            <div class="t">üë§ ATIVOS DISPON√çVEIS</div>
                            <div class="count" id="aCount"></div>
                        </div>
                        <div class="rows" id="assets"></div>
                        <div class="hint">
                            Regra impl√≠cita: 1 ativo ‚Üí solo ¬∑ 2+ ativos ‚Üí duo
                            (quando existir cluster). O cinematic √© um ‚Äúoverlay‚Äù
                            opcional.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action bar -->
        <div class="actionbar">
            <div class="actionbar-inner">
                <div class="summary" id="summary">
                    <span class="tag"
                        ><span class="k">Left</span>
                        <span class="v" id="sumLeft">‚Äî</span></span
                    >
                    <span class="tag"
                        ><span class="k">Assets</span>
                        <span class="v" id="sumAssets">0</span></span
                    >
                    <span class="tag"
                        ><span class="k">üé¨</span>
                        <span class="v" id="sumCine">off</span></span
                    >
                    <span class="tag"
                        ><span class="k">‚ö°</span>
                        <span class="v" id="sumCold">off</span></span
                    >
                </div>

                <div class="btns">
                    <button class="btn" id="btnClear" type="button">
                        üßπ Limpar
                    </button>
                    <button
                        class="btn secondary"
                        id="btnPreview"
                        type="button"
                        disabled
                    >
                        üëÅÔ∏è Pr√©via
                    </button>
                    <button
                        class="btn primary"
                        id="btnGenerate"
                        type="button"
                        disabled
                    >
                        ‚ö° Gerar + Copiar
                    </button>
                </div>
            </div>
        </div>

        <div class="toast" id="toast"></div>

        <script>
            const $ = (id) => document.getElementById(id);

            let DATA = { universes: [], spaces: [], clusters: [], assets: [] };

            // selection state
            let selectedUniverseId = null;
            let selectedSpaceId = null;
            let selectedAssetIds = new Set();

            // toggles
            let cinematicOn = false;
            let coldOpenOn = false;

            let lastPrompt = "";

            function toast(html) {
                const el = $("toast");
                el.innerHTML = html;
                el.style.display = "block";
                clearTimeout(toast._t);
                toast._t = setTimeout(() => {
                    el.style.display = "none";
                }, 2600);
            }

            function showMsg(kind, html) {
                const el = $("message");
                el.className = "msg" + (kind === "error" ? " error" : "");
                el.innerHTML = html;
                el.style.display = "block";
            }

            function setStatus(text) {
                $("status").textContent = text;
            }

            function norm(s) {
                return (s ?? "")
                    .toString()
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "")
                    .toLowerCase();
            }

            function badge(text, cls) {
                const b = document.createElement("span");
                b.className = `badge ${cls || ""}`.trim();
                b.textContent = text;
                return b;
            }

            function byId(a, b) {
                const rx = /^([A-Z]+)-(\d+)/;
                const ma = rx.exec(a) || [];
                const mb = rx.exec(b) || [];
                const pa = ma[1] || a;
                const pb = mb[1] || b;
                if (pa !== pb) return pa.localeCompare(pb);
                const na = parseInt(ma[2] || "0", 10);
                const nb = parseInt(mb[2] || "0", 10);
                return na - nb;
            }

            async function loadJSON(path) {
                const r = await fetch(path, { cache: "no-store" });
                if (!r.ok) throw new Error(`${path} -> HTTP ${r.status}`);
                return await r.json();
            }

            function extractSpaces(spacesJSON) {
                if (spacesJSON && Array.isArray(spacesJSON.spaces))
                    return spacesJSON.spaces;
                if (Array.isArray(spacesJSON)) return spacesJSON;
                return [];
            }

            function extractClusters(spacesJSON) {
                if (spacesJSON && Array.isArray(spacesJSON.clusters))
                    return spacesJSON.clusters;
                return [];
            }

            function extractUniverses(universesJSON) {
                if (universesJSON && Array.isArray(universesJSON.universes))
                    return universesJSON.universes;
                if (Array.isArray(universesJSON)) return universesJSON;
                return [];
            }

            // extractor el√°stico
            function extractAssets(assetsJSON) {
                if (assetsJSON && Array.isArray(assetsJSON.assets))
                    return assetsJSON.assets;
                if (Array.isArray(assetsJSON)) return assetsJSON;

                const commonKeys = [
                    "items",
                    "data",
                    "list",
                    "people",
                    "actors",
                ];
                for (const k of commonKeys) {
                    if (assetsJSON && Array.isArray(assetsJSON[k]))
                        return assetsJSON[k];
                }

                if (assetsJSON && typeof assetsJSON === "object") {
                    for (const v of Object.values(assetsJSON)) {
                        if (
                            Array.isArray(v) &&
                            v.length &&
                            typeof v[0] === "object"
                        ) {
                            const x = v[0];
                            if (
                                "asset_id" in x ||
                                ("nome" in x && "sobrenome" in x)
                            )
                                return v;
                        }
                        if (v && typeof v === "object") {
                            for (const vv of Object.values(v)) {
                                if (
                                    Array.isArray(vv) &&
                                    vv.length &&
                                    typeof vv[0] === "object"
                                ) {
                                    const x = vv[0];
                                    if (
                                        "asset_id" in x ||
                                        ("nome" in x && "sobrenome" in x)
                                    )
                                        return vv;
                                }
                            }
                        }
                    }
                }
                return [];
            }

            function makeRow({
                id,
                name,
                search,
                extraBadge,
                onClick,
                selected = false,
            }) {
                const row = document.createElement("div");
                row.className = "row" + (selected ? " selected" : "");
                row.dataset.search = norm(search || `${id} ${name}`);
                row.dataset.id = id;

                const idEl = document.createElement("div");
                idEl.className = "id";
                idEl.textContent = id;

                const nameEl = document.createElement("div");
                nameEl.className = "name";
                nameEl.textContent = name;

                if (extraBadge) nameEl.appendChild(extraBadge);

                row.appendChild(idEl);
                row.appendChild(nameEl);

                row.addEventListener("click", onClick);
                row.addEventListener("touchstart", () => {}, { passive: true });
                return row;
            }

            function updateSummary() {
                const left = selectedUniverseId
                    ? selectedUniverseId
                    : selectedSpaceId
                      ? selectedSpaceId
                      : "‚Äî";
                $("sumLeft").textContent = left;
                $("sumAssets").textContent = String(selectedAssetIds.size);
                $("sumCine").textContent = cinematicOn ? "on" : "off";
                $("sumCold").textContent = coldOpenOn ? "on" : "off";

                const hasSomething = Boolean(
                    selectedUniverseId ||
                    selectedSpaceId ||
                    selectedAssetIds.size,
                );
                $("btnGenerate").disabled = !hasSomething;
                $("btnPreview").disabled = !hasSomething;
            }

            function applyFilter() {
                const q = norm($("filter").value);
                document.querySelectorAll(".row").forEach((r) => {
                    const ok = !q || (r.dataset.search || "").includes(q);
                    r.style.display = ok ? "" : "none";
                });
            }

            function clearSelection() {
                selectedUniverseId = null;
                selectedSpaceId = null;
                selectedAssetIds = new Set();
                document
                    .querySelectorAll(".row.selected")
                    .forEach((r) => r.classList.remove("selected"));
                lastPrompt = "";
                updateSummary();
                toast(
                    `<b>Limpo.</b> Selecione um universo/espa√ßo e os ativos.`,
                );
            }

            function selectUniverse(uid) {
                selectedUniverseId = uid;
                selectedSpaceId = null;
                document
                    .querySelectorAll("#universes .row, #spaces .row")
                    .forEach((r) => r.classList.remove("selected"));
                const row = document.querySelector(
                    `#universes .row[data-id="${CSS.escape(uid)}"]`,
                );
                if (row) row.classList.add("selected");
                updateSummary();
            }

            function selectSpace(sid) {
                selectedSpaceId = sid;
                selectedUniverseId = null;
                document
                    .querySelectorAll("#universes .row, #spaces .row")
                    .forEach((r) => r.classList.remove("selected"));
                const row = document.querySelector(
                    `#spaces .row[data-id="${CSS.escape(sid)}"]`,
                );
                if (row) row.classList.add("selected");
                updateSummary();
            }

            function toggleAsset(aid) {
                if (selectedAssetIds.has(aid)) selectedAssetIds.delete(aid);
                else selectedAssetIds.add(aid);
                const row = document.querySelector(
                    `#assets .row[data-id="${CSS.escape(aid)}"]`,
                );
                if (row)
                    row.classList.toggle("selected", selectedAssetIds.has(aid));
                updateSummary();
            }

            function getUniverseById(id) {
                return (
                    DATA.universes.find(
                        (u) => (u.id || u.universe_id) === id,
                    ) || null
                );
            }
            function getSpaceById(id) {
                return DATA.spaces.find((s) => s.id === id) || null;
            }
            function getAssetById(id) {
                return (
                    DATA.assets.find((a) => (a.asset_id || a.id) === id) || null
                );
            }

            function buildClusterIndex() {
                const idx = new Map();
                for (const c of DATA.clusters) {
                    if (!c) continue;
                    if (c.cluster_id) idx.set(c.cluster_id, c);
                    if (c.id) idx.set(c.id, c);
                }
                return idx;
            }

            // ---------- Prompt builder (mais narrativo) ----------
            function pick(obj, keys) {
                for (const k of keys) {
                    if (
                        obj &&
                        obj[k] !== undefined &&
                        obj[k] !== null &&
                        obj[k] !== ""
                    )
                        return obj[k];
                }
                return null;
            }

            function bullets(arr) {
                if (!Array.isArray(arr) || !arr.length) return "";
                return arr.map((x) => `- ${String(x)}`).join("\n");
            }

            function cinematicOverlay() {
                return [
                    "üé¨ **Modo cinematic (overlay)**",
                    "- Trate como curta cinematogr√°fico: c√¢mera consciente, ritmo, tens√£o, cortes.",
                    "- Fotografia: luz, textura, profundidade de campo, respira√ß√£o do ambiente.",
                    "- Dire√ß√£o: decis√µes visuais claras; menos explica√ß√£o, mais imagem em movimento.",
                    "- Edi√ß√£o: cortes secos quando necess√°rio; alternar planos (wide ‚Üí m√©dio ‚Üí close).",
                    "- Som: camadas (ru√≠do de fundo, impacto, respira√ß√£o, sil√™ncio).",
                ].join("\n");
            }

            function coldOpenOverlay() {
                return [
                    "‚ö° **Cold open (come√ßar no impacto)**",
                    "- Comece *em plena a√ß√£o*, sem aquecimento lento.",
                    "- O leitor deve entender o contexto pelos sinais (movimento, som, urg√™ncia).",
                    "- S√≥ depois, em pequenos flashes, revele o ‚Äúonde/por qu√™‚Äù.",
                ].join("\n");
            }

            function describeAssetsNarrative(selectedAssets) {
                let out = "## Elenco (ativos)\n\n";
                out +=
                    "Use os dados abaixo como √¢ncora. Expanda com liberdade: gestos, voz, presen√ßa, micro-h√°bitos, magnetismo.\n\n";
                for (const a of selectedAssets) {
                    const full =
                        `${a.nome || ""} ${a.sobrenome || ""}`.trim() ||
                        a.asset_id ||
                        a.id ||
                        "Ativo";
                    const birth = pick(a, ["data_nascimento", "nascimento"]);
                    const idade = pick(a, ["idade"]);
                    const signo = pick(a, ["signo"]);
                    const altura = pick(a, ["altura_cm"]);
                    const peso = pick(a, ["peso_kg"]);

                    const hair = pick(a, ["cor_cabelo"]);
                    const cut = pick(a, ["corte_penteado"]);
                    const skin = pick(a, ["cor_pele"]);
                    const eyes = pick(a, ["cor_olhos"]);

                    const body = pick(a, ["estrutura_corpo"]);
                    const fat = pick(a, ["tecido_adiposo"]);
                    const mus = pick(a, ["musculatura"]);

                    const persona = pick(a, ["personalidade"]);
                    const asc = pick(a, ["ascendente"]);
                    const ascConf = pick(a, [
                        "ascendente_confianca",
                        "ascendente_confidence",
                    ]);

                    const facts = [];
                    if (birth) facts.push(`nasc. ${birth}`);
                    if (idade !== null && idade !== undefined)
                        facts.push(`idade ${idade}`);
                    if (signo) facts.push(`signo ${signo}`);
                    if (altura) facts.push(`${altura} cm`);
                    if (peso) facts.push(`${peso} kg`);

                    const look = [];
                    if (hair) look.push(`cabelo ${hair}`);
                    if (cut) look.push(`${cut}`);
                    if (skin) look.push(`pele ${skin}`);
                    if (eyes) look.push(`olhos ${eyes}`);

                    const corpo = [];
                    if (body) corpo.push(body);
                    if (fat !== null && fat !== undefined)
                        corpo.push(`adiposo ${fat}/100`);
                    if (mus !== null && mus !== undefined)
                        corpo.push(`m√∫sculo ${mus}/100`);

                    const ps = [];
                    if (persona) ps.push(persona);
                    if (asc) {
                        const confTxt =
                            ascConf !== null && ascConf !== undefined
                                ? ` (conf. ${ascConf})`
                                : "";
                        ps.push(`ascendente ${asc}${confTxt}`);
                    }

                    out += `- **${full}**\n`;
                    if (facts.length)
                        out += `  - Dados: ${facts.join(" ¬∑ ")}\n`;
                    if (look.length)
                        out += `  - Apar√™ncia: ${look.join(" ¬∑ ")}\n`;
                    if (corpo.length)
                        out += `  - Corpo: ${corpo.join(" ¬∑ ")}\n`;
                    if (ps.length) out += `  - Psicologia: ${ps.join(" ¬∑ ")}\n`;
                    out += `  - Figurino: marcas premium e bonitas; o look responde ao ambiente e ao status na cena.\n`;
                }
                out += "\n";
                return out;
            }

            function describeUniverseNarrative(u) {
                const name = pick(u, ["name", "title"]) || u.id || "Universo";
                const premise = pick(u, [
                    "premise",
                    "premissa",
                    "logline",
                    "one_liner",
                    "description",
                    "descricao",
                ]);

                let out = `## Universo ativo\n\n**${name}**\n\n`;

                if (premise) {
                    out += `### Premissa\n\n${premise}\n\n`;
                }

                const laws = pick(u, ["laws", "rules", "leis", "regras"]);
                if (Array.isArray(laws) && laws.length) {
                    out += "### Leis do mundo (√¢ncora)\n\n";
                    out += bullets(laws) + "\n\n";
                } else if (typeof laws === "string" && laws.trim()) {
                    out += "### Leis do mundo (√¢ncora)\n\n";
                    out += laws.trim() + "\n\n";
                }

                const safety = pick(u, [
                    "safety_envelope",
                    "safety",
                    "envelope",
                ]);
                if (safety) {
                    out += "### Envelope de seguran√ßa\n\n";
                    if (typeof safety === "string") {
                        out += safety + "\n\n";
                    } else {
                        for (const [k, v] of Object.entries(safety)) {
                            if (Array.isArray(v))
                                out += `- ${k}:\n${v.map((x) => `  - ${x}`).join("\n")}\n`;
                            else out += `- ${k}: ${String(v)}\n`;
                        }
                        out += "\n";
                    }
                }

                out += "### Dire√ß√£o criativa\n\n";
                out +=
                    [
                        "- Voc√™ tem licen√ßa para criar *qualquer espa√ßo* necess√°rio dentro deste universo.",
                        "- Evite burocracia: escreva com presen√ßa, ritmo e decis√µes concretas.",
                        "- N√£o liste IDs/c√≥digos. Trate tudo como descri√ß√£o humana e visual.",
                    ].join("\n") + "\n\n";

                return out;
            }

            function describeSpaceNarrative(s, clusterCtx) {
                const name = s?.name || s?.title || "Espa√ßo";

                let out = `## Espa√ßo ativo\n\n**${name}**\n\n`;

                // ambientes / objetos / regras
                const objects = pick(s, ["objects", "objetos"]);
                if (Array.isArray(objects) && objects.length) {
                    out += "### Cena / elementos\n\n";
                    out += bullets(objects) + "\n\n";
                }

                const rules = pick(s, ["rules", "regras"]);
                if (Array.isArray(rules) && rules.length) {
                    out += "### Regras do espa√ßo (√¢ncora)\n\n";
                    out += bullets(rules) + "\n\n";
                }

                // sem√¢ntica rica (se houver)
                const semKeys = [
                    "biomechanics",
                    "balance_model",
                    "leverage_model",
                    "wardrobe_policy",
                    "erotization_level",
                ];
                const anySem = semKeys.some((k) => s && s[k] !== undefined);
                if (anySem) {
                    out += "### Par√¢metros (sinaliza√ß√£o)\n\n";
                    for (const k of semKeys) {
                        const v = s[k];
                        if (v === undefined || v === null) continue;
                        if (typeof v === "object") {
                            out += `- ${k}:\n`;
                            if (Array.isArray(v))
                                out +=
                                    v.map((x) => `  - ${x}`).join("\n") + "\n";
                            else
                                out +=
                                    Object.entries(v)
                                        .map(
                                            ([kk, vv]) =>
                                                `  - ${kk}: ${String(vv)}`,
                                        )
                                        .join("\n") + "\n";
                        } else {
                            out += `- ${k}: ${String(v)}\n`;
                        }
                    }
                    out += "\n";
                }

                // cluster (se aplic√°vel)
                if (clusterCtx) {
                    out += "### Contrato transversal (cluster)\n\n";
                    out += `- Cluster: ${clusterCtx.name || clusterCtx.id}\n`;
                    if (clusterCtx.variation)
                        out += `- Varia√ß√£o inferida: ${clusterCtx.variation}\n`;
                    out += "\n";

                    if (clusterCtx.contract) {
                        const c = clusterCtx.contract;
                        if (
                            Array.isArray(c.core_principles) &&
                            c.core_principles.length
                        ) {
                            out +=
                                "**Princ√≠pios**\n" +
                                bullets(c.core_principles) +
                                "\n\n";
                        }
                        if (
                            Array.isArray(c.forbidden_outcomes) &&
                            c.forbidden_outcomes.length
                        ) {
                            out +=
                                "**Evitar**\n" +
                                bullets(c.forbidden_outcomes) +
                                "\n\n";
                        }
                    }

                    // se houver varia√ß√£o ‚Äúsolo/duo/cinematic‚Äù no schema do cluster
                    const vars = clusterCtx.variations;
                    const chosenKey = clusterCtx.variationKey;
                    if (vars && chosenKey && vars[chosenKey]) {
                        const vd = vars[chosenKey];
                        out += `**Dire√ß√£o da varia√ß√£o (${chosenKey})**\n\n`;
                        if (typeof vd === "string") out += vd + "\n\n";
                        else if (vd && typeof vd === "object") {
                            for (const [k, v] of Object.entries(vd)) {
                                if (Array.isArray(v))
                                    out += `- ${k}:\n${v.map((x) => `  - ${x}`).join("\n")}\n`;
                                else out += `- ${k}: ${String(v)}\n`;
                            }
                            out += "\n";
                        }
                    }
                }

                out += "### Dire√ß√£o criativa\n\n";
                out +=
                    [
                        "- Escreva como cena viva: inten√ß√£o, tens√£o, f√≠sica, microdecis√µes.",
                        "- Figurino premium e coerente com o ambiente; estilo fala antes da fala.",
                        "- N√£o liste IDs/c√≥digos.",
                    ].join("\n") + "\n\n";

                return out;
            }

            function buildPrompt() {
                const selectedAssets = Array.from(selectedAssetIds)
                    .map((id) => getAssetById(id))
                    .filter(Boolean);

                const hasU = Boolean(selectedUniverseId);
                const hasS = Boolean(selectedSpaceId);
                const hasA = selectedAssets.length > 0;

                // overlays (narrativos)
                let overlays = [];
                if (coldOpenOn) overlays.push(coldOpenOverlay());
                if (cinematicOn) overlays.push(cinematicOverlay());

                const overlaysBlock = overlays.length
                    ? "## Overlays (dire√ß√£o extra)\n\n" +
                      overlays.join("\n\n") +
                      "\n\n"
                    : "";

                // UNIVERSO (+ assets opcional)
                if (hasU) {
                    const u = getUniverseById(selectedUniverseId);
                    const name =
                        (u && (u.name || u.title)) || selectedUniverseId;

                    let out = `MATRIX ‚Äî PROMPT (UNIVERSO${hasA ? " + ELENCO" : ""})\n\n`;
                    out += overlaysBlock;
                    if (u) out += describeUniverseNarrative(u);
                    else out += `## Universo ativo\n\n**${name}**\n\n`;

                    if (hasA) out += describeAssetsNarrative(selectedAssets);

                    out += "## Execu√ß√£o\n\n";
                    out +=
                        [
                            "- Use as √¢ncoras acima e crie o necess√°rio com liberdade para o mundo funcionar.",
                            "- Priorize imagem, ritmo e escolhas concretas. Menos explica√ß√£o, mais presen√ßa.",
                            "- Continuidade vale dentro do chat; novo prompt redefine o setup.",
                        ].join("\n") + "\n";

                    return out.trim() + "\n";
                }

                // ESPA√áO (+ assets opcional)
                if (hasS) {
                    const s = getSpaceById(selectedSpaceId);

                    // cluster resolution + varia√ß√£o inferida
                    let clusterCtx = null;
                    const clusterIndex = buildClusterIndex();

                    if (
                        s &&
                        s.cluster_binding &&
                        s.cluster_binding.cluster_id
                    ) {
                        const cid = s.cluster_binding.cluster_id;
                        const c = clusterIndex.get(cid);

                        if (
                            s.cluster_binding.requires_cluster_validation &&
                            !c
                        ) {
                            throw new Error(
                                `Space ${s.id} exige cluster ${cid}, mas o cluster n√£o existe.`,
                            );
                        }

                        if (c) {
                            // regra: solo/duo por assets
                            const baseVar = hasA
                                ? selectedAssets.length >= 2
                                    ? "duo"
                                    : "solo"
                                : null;

                            // cinematic: overlay global, mas se cluster tiver ‚Äúcinematic‚Äù, usamos tamb√©m
                            const variationKey = cinematicOn
                                ? "cinematic"
                                : baseVar;

                            clusterCtx = {
                                id: cid,
                                name: c.name || cid,
                                contract: c.contract || null,
                                variations: c.variations || null,
                                variation: variationKey || null,
                                variationKey: variationKey || null,
                            };
                        }
                    }

                    let out = `MATRIX ‚Äî PROMPT (ESPA√áO${hasA ? " + ELENCO" : ""})\n\n`;
                    out += overlaysBlock;

                    if (s) out += describeSpaceNarrative(s, clusterCtx);
                    else out += `## Espa√ßo ativo\n\n**${selectedSpaceId}**\n\n`;

                    if (hasA) out += describeAssetsNarrative(selectedAssets);

                    out += "## Execu√ß√£o\n\n";
                    out +=
                        [
                            "- Use o espa√ßo como √¢ncora e deixe a cena respirar (sem engessar).",
                            "- Se houver elenco, distribua foco e energia com inten√ß√£o (solo/duo impl√≠cito).",
                            "- Continuidade vale dentro do chat; novo prompt redefine o setup.",
                        ].join("\n") + "\n";

                    return out.trim() + "\n";
                }

                // ASSETS ONLY
                if (hasA) {
                    let out = `MATRIX ‚Äî PROMPT (ELENCO)\n\n`;
                    out += overlaysBlock;
                    out += describeAssetsNarrative(selectedAssets);

                    out += "## Execu√ß√£o\n\n";
                    out +=
                        [
                            "- Crie o ambiente necess√°rio livremente (sem burocracia).",
                            "- Figurino premium e coerente com o status e com a luz.",
                            "- N√£o liste IDs/c√≥digos.",
                        ].join("\n") + "\n";

                    return out.trim() + "\n";
                }

                return "";
            }

            async function copyToClipboard(text) {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                    return true;
                }
                const ta = document.createElement("textarea");
                ta.value = text;
                ta.style.position = "fixed";
                ta.style.left = "-9999px";
                document.body.appendChild(ta);
                ta.select();
                const ok = document.execCommand("copy");
                document.body.removeChild(ta);
                return ok;
            }

            function openPreview(prompt) {
                const w = window.open("", "_blank");
                if (!w) {
                    toast(
                        `<b>Popup bloqueado.</b> Use Gerar+Copiar mesmo assim.`,
                    );
                    return;
                }
                w.document.write(
                    `<pre style="white-space:pre-wrap;font-family:ui-monospace, Menlo, Monaco, Consolas, monospace; padding:16px; background:#0b0e14; color:#d7dde8;">${escapeHtml(prompt)}</pre>`,
                );
                w.document.close();
            }

            function escapeHtml(s) {
                return String(s).replace(
                    /[&<>"']/g,
                    (c) =>
                        ({
                            "&": "&amp;",
                            "<": "&lt;",
                            ">": "&gt;",
                            '"': "&quot;",
                            "'": "&#39;",
                        })[c],
                );
            }

            function renderAll() {
                const uBox = $("universes");
                const sBox = $("spaces");
                const aBox = $("assets");
                uBox.innerHTML = "";
                sBox.innerHTML = "";
                aBox.innerHTML = "";

                $("uCount").textContent = `${DATA.universes.length} itens`;
                $("sCount").textContent = `${DATA.spaces.length} itens`;
                $("aCount").textContent = `${DATA.assets.length} itens`;

                const hasCluster = DATA.spaces.some(
                    (s) => s.cluster_binding && s.cluster_binding.cluster_id,
                );
                if (hasCluster) {
                    $("clusterHint").style.display = "block";
                    $("clusterHint").textContent =
                        "Spaces com badge pertencem a um Cluster (contrato herdado). Clusters n√£o s√£o execut√°veis.";
                } else {
                    $("clusterHint").style.display = "none";
                }

                DATA.universes
                    .slice()
                    .sort((x, y) => byId(x.id || "", y.id || ""))
                    .forEach((u) => {
                        const uid = u.id || u.universe_id || "";
                        const name = u.name || u.title || "(sem nome)";
                        const row = makeRow({
                            id: uid,
                            name,
                            search: `${uid} ${name}`,
                            selected: uid === selectedUniverseId,
                            onClick: () => selectUniverse(uid),
                        });
                        uBox.appendChild(row);
                    });

                const clusterIndex = buildClusterIndex();
                DATA.spaces
                    .slice()
                    .sort((x, y) => byId(x.id || "", y.id || ""))
                    .forEach((s) => {
                        const sid = s.id || "";
                        const name = s.name || "(sem nome)";
                        let b = null;
                        if (s.cluster_binding && s.cluster_binding.cluster_id) {
                            const c = clusterIndex.get(
                                s.cluster_binding.cluster_id,
                            );
                            const label = c?.name
                                ? `C ${c.name}`
                                : `C ${s.cluster_binding.cluster_id}`;
                            b = badge(label, "c");
                        }
                        const row = makeRow({
                            id: sid,
                            name,
                            search: `${sid} ${name}`,
                            extraBadge: b,
                            selected: sid === selectedSpaceId,
                            onClick: () => selectSpace(sid),
                        });
                        sBox.appendChild(row);
                    });

                DATA.assets
                    .slice()
                    .sort((x, y) =>
                        byId(
                            x.asset_id || x.id || "",
                            y.asset_id || y.id || "",
                        ),
                    )
                    .forEach((a) => {
                        const aid = a.asset_id || a.id || "";
                        const full =
                            `${a.nome || ""} ${a.sobrenome || ""}`.trim() ||
                            "(sem nome)";
                        const row = makeRow({
                            id: aid,
                            name: full,
                            search: `${aid} ${full}`,
                            selected: selectedAssetIds.has(aid),
                            onClick: () => toggleAsset(aid),
                        });
                        aBox.appendChild(row);
                    });

                updateSummary();
                applyFilter();
            }

            function setChip(el, on) {
                el.classList.toggle("on", on);
                el.setAttribute("aria-pressed", on ? "true" : "false");
                const small = el.querySelector("small");
                if (small) small.textContent = on ? "(on)" : "(off)";
            }

            function toggleChip(el, which) {
                if (which === "cinematic") {
                    cinematicOn = !cinematicOn;
                    setChip(el, cinematicOn);
                } else if (which === "cold") {
                    coldOpenOn = !coldOpenOn;
                    setChip(el, coldOpenOn);
                }
                updateSummary();
            }

            async function init() {
                try {
                    setStatus("LOADING");
                    showMsg(
                        "",
                        `<b>Carregando</b> assets.json ¬∑ spaces.json ¬∑ universes.json ‚Ä¶`,
                    );

                    const [assetsJSON, spacesJSON, universesJSON] =
                        await Promise.all([
                            loadJSON("./assets.json"),
                            loadJSON("./spaces.json"),
                            loadJSON("./universes.json"),
                        ]);

                    DATA.assets = extractAssets(assetsJSON);
                    DATA.spaces = extractSpaces(spacesJSON);
                    DATA.clusters = extractClusters(spacesJSON);
                    DATA.universes = extractUniverses(universesJSON);

                    if (
                        !DATA.assets.length &&
                        !DATA.spaces.length &&
                        !DATA.universes.length
                    ) {
                        throw new Error(
                            "Nenhum dado carregado (JSONs vazios ou formato inesperado).",
                        );
                    }

                    $("message").style.display = "none";
                    $("dash").style.display = "grid";
                    setStatus("READY");

                    $("filter").addEventListener("input", applyFilter);

                    // chips
                    setChip($("chipCinematic"), cinematicOn);
                    setChip($("chipColdOpen"), coldOpenOn);

                    const cine = $("chipCinematic");
                    const cold = $("chipColdOpen");

                    cine.addEventListener("click", () =>
                        toggleChip(cine, "cinematic"),
                    );
                    cold.addEventListener("click", () =>
                        toggleChip(cold, "cold"),
                    );

                    cine.addEventListener("keydown", (e) => {
                        if (e.key === "Enter" || e.key === " ") {
                            e.preventDefault();
                            toggleChip(cine, "cinematic");
                        }
                    });
                    cold.addEventListener("keydown", (e) => {
                        if (e.key === "Enter" || e.key === " ") {
                            e.preventDefault();
                            toggleChip(cold, "cold");
                        }
                    });

                    // buttons
                    $("btnClear").addEventListener("click", clearSelection);

                    $("btnPreview").addEventListener("click", () => {
                        try {
                            const prompt = buildPrompt();
                            if (!prompt) return;
                            lastPrompt = prompt;
                            openPreview(prompt);
                        } catch (e) {
                            toast(
                                `<b>Erro:</b> ${escapeHtml(e.message || String(e))}`,
                            );
                        }
                    });

                    $("btnGenerate").addEventListener("click", async () => {
                        try {
                            const prompt = buildPrompt();
                            if (!prompt) {
                                toast(
                                    `<b>Nada selecionado.</b> Escolha um universo/espa√ßo e/ou ativos.`,
                                );
                                return;
                            }
                            lastPrompt = prompt;
                            const ok = await copyToClipboard(prompt);
                            if (ok)
                                toast(
                                    `<b>Copiado!</b> Agora √© s√≥ colar no Gemini.`,
                                );
                            else
                                toast(
                                    `<b>Falhou ao copiar.</b> Use a pr√©via para copiar manualmente.`,
                                );
                        } catch (e) {
                            toast(
                                `<b>Erro:</b> ${escapeHtml(e.message || String(e))}`,
                            );
                        }
                    });

                    renderAll();
                    updateSummary();
                    toast(
                        `<b>Ready.</b> Agora voc√™ tem üé¨ cinematic e ‚ö° cold open como overlays.`,
                    );
                } catch (err) {
                    setStatus("ERROR");
                    showMsg(
                        "error",
                        `<b>Erro ao carregar dados.</b><br><br>
           ${String(err.message || err)}<br><br>
           Confirme que <code>assets.json</code>, <code>spaces.json</code> e <code>universes.json</code> est√£o na raiz do repo e acess√≠veis pelo Pages.`,
                    );
                }
            }

            init();
        </script>
    </body>
</html>
