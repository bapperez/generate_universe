<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>MATRIX :: CONSOLE</title>

        <style>
            :root {
                --bg: #0b0e14;
                --panel: #0f1521;
                --panel2: #0c111b;
                --text: #d7dde8;
                --muted: #8b93a7;

                /* ‚ÄúANSI sutis‚Äù */
                --cyan: #58c7d7;
                --blue: #6aa6ff;
                --gray: #9aa3b5;
                --line: #1d2940;
                --line2: #142033;

                --good: #73e6c7;
                --warn: #ffcf5a;
                --bad: #ff6b86;

                --mono:
                    ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
                    "Liberation Mono", monospace;
                --sans:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Helvetica, Arial, sans-serif;
            }

            * {
                box-sizing: border-box;
            }
            html,
            body {
                height: 100%;
            }
            body {
                margin: 0;
                background: radial-gradient(
                    1200px 600px at 20% 0%,
                    #0f1626 0%,
                    var(--bg) 60%
                );
                color: var(--text);
                font-family: var(--mono);
                letter-spacing: 0.2px;
            }

            .wrap {
                max-width: 1050px;
                margin: 28px auto;
                padding: 0 18px 38px;
            }

            /* Header ‚Äúbox‚Äù estilo terminal */
            .header-box {
                border: 1px solid var(--line);
                border-radius: 12px;
                background: linear-gradient(
                    180deg,
                    rgba(255, 255, 255, 0.03),
                    rgba(255, 255, 255, 0.01)
                );
                padding: 14px 16px;
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
            }

            .header-top {
                display: flex;
                gap: 12px;
                align-items: center;
                justify-content: space-between;
                flex-wrap: wrap;
            }

            .brand {
                display: flex;
                align-items: baseline;
                gap: 10px;
                min-width: 260px;
            }
            .brand .title {
                font-weight: 700;
                color: var(--cyan);
                font-size: 14px;
                letter-spacing: 1.2px;
            }
            .brand .subtitle {
                color: var(--muted);
                font-size: 12px;
                font-family: var(--sans);
            }

            .statusline {
                display: flex;
                gap: 14px;
                flex-wrap: wrap;
                font-size: 12px;
                color: var(--gray);
            }
            .pill {
                border: 1px solid var(--line2);
                background: rgba(88, 199, 215, 0.06);
                padding: 6px 10px;
                border-radius: 999px;
                display: flex;
                gap: 6px;
                align-items: center;
            }
            .pill b {
                color: var(--text);
                font-weight: 600;
            }
            .dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--good);
                box-shadow: 0 0 12px rgba(115, 230, 199, 0.35);
            }

            .controls {
                margin-top: 12px;
                display: flex;
                gap: 12px;
                flex-wrap: wrap;
                align-items: center;
            }
            .control {
                display: flex;
                gap: 8px;
                align-items: center;
                border: 1px solid var(--line2);
                background: rgba(255, 255, 255, 0.02);
                border-radius: 10px;
                padding: 10px 12px;
                flex: 1 1 320px;
                min-width: 240px;
            }
            .control label {
                color: var(--muted);
                font-size: 12px;
                font-family: var(--sans);
                white-space: nowrap;
            }
            .control input {
                width: 100%;
                background: transparent;
                border: none;
                outline: none;
                color: var(--text);
                font-family: var(--mono);
                font-size: 13px;
            }

            /* Dashboard layout */
            .dash {
                margin-top: 18px;
                display: grid;
                grid-template-columns: 1.12fr 0.88fr; /* esquerda + direita */
                gap: 16px;
            }
            @media (max-width: 860px) {
                .dash {
                    grid-template-columns: 1fr;
                }
            }

            .panel {
                border: 1px solid var(--line);
                border-radius: 12px;
                background: rgba(15, 21, 33, 0.65);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.28);
                overflow: hidden;
            }
            .panel .panel-head {
                padding: 12px 14px;
                border-bottom: 1px solid var(--line2);
                background: rgba(12, 17, 27, 0.7);
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 10px;
            }
            .panel .panel-head .h {
                color: var(--cyan);
                font-weight: 700;
                letter-spacing: 0.8px;
                font-size: 13px;
            }
            .panel .panel-head .meta {
                color: var(--muted);
                font-size: 12px;
                font-family: var(--sans);
            }

            .section {
                padding: 10px 14px 14px;
            }
            .section + .section {
                border-top: 1px dashed rgba(29, 41, 64, 0.7);
                padding-top: 12px;
            }
            .section-title {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 10px;
                margin: 2px 0 10px;
            }
            .section-title .t {
                color: var(--blue);
                font-weight: 700;
                font-size: 13px;
                letter-spacing: 0.6px;
            }
            .section-title .count {
                color: var(--muted);
                font-size: 12px;
                font-family: var(--sans);
            }

            /* ‚Äúlinhas‚Äù estilo terminal, mas com grid */
            .rows {
                display: flex;
                flex-direction: column;
                gap: 6px;
            }
            .row {
                display: grid;
                grid-template-columns: 74px 1fr; /* ID | nome */
                gap: 12px;
                align-items: baseline;
                padding: 7px 10px;
                border-radius: 10px;
                border: 1px solid transparent;
                background: rgba(255, 255, 255, 0.01);
            }
            .row:hover {
                border-color: rgba(106, 166, 255, 0.25);
                background: rgba(106, 166, 255, 0.06);
            }
            .id {
                color: var(--gray);
                font-weight: 700;
                letter-spacing: 0.4px;
            }
            .name {
                color: var(--text);
                font-family: var(--sans);
                font-size: 13px;
                line-height: 1.25;
            }
            .hint {
                margin-top: 12px;
                color: var(--muted);
                font-family: var(--sans);
                font-size: 12px;
            }

            .footer {
                margin-top: 16px;
                color: rgba(139, 147, 167, 0.75);
                font-family: var(--sans);
                font-size: 12px;
                text-align: center;
            }

            /* Small badge for legacy or cluster */
            .badge {
                display: inline-flex;
                gap: 6px;
                align-items: center;
                font-size: 11px;
                font-family: var(--sans);
                color: rgba(215, 221, 232, 0.9);
                border: 1px solid rgba(255, 255, 255, 0.08);
                background: rgba(255, 255, 255, 0.03);
                padding: 3px 8px;
                border-radius: 999px;
                margin-left: 8px;
                vertical-align: middle;
                white-space: nowrap;
            }
            .badge.c {
                border-color: rgba(88, 199, 215, 0.2);
                background: rgba(88, 199, 215, 0.1);
                color: rgba(180, 240, 248, 0.95);
            }
            .badge.w {
                border-color: rgba(255, 207, 90, 0.22);
                background: rgba(255, 207, 90, 0.1);
                color: rgba(255, 235, 190, 0.95);
            }

            /* Loading / error */
            .msg {
                margin-top: 16px;
                border: 1px solid var(--line);
                border-radius: 12px;
                padding: 14px 16px;
                background: rgba(15, 21, 33, 0.5);
                font-family: var(--sans);
                color: var(--muted);
            }
            .msg b {
                color: var(--text);
            }
            .msg.error {
                border-color: rgba(255, 107, 134, 0.25);
            }
            .msg.error b {
                color: var(--bad);
            }
        </style>
    </head>

    <body>
        <div class="wrap">
            <div class="header-box">
                <div class="header-top">
                    <div class="brand">
                        <div class="title">MATRIX :: CONSOLE</div>
                        <div class="subtitle">
                            dashboard (web) espelhando o go.py
                        </div>
                    </div>

                    <div class="statusline">
                        <div class="pill">
                            <span class="dot"></span> <span>STATUS:</span>
                            <b id="status">LOADING</b>
                        </div>
                        <div class="pill">
                            <span>MODE:</span> <b>CATALOG</b>
                        </div>
                        <div class="pill">
                            <span>VERSION:</span> <b id="version">web-1.0</b>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <div class="control">
                        <label for="filter">Filtro</label>
                        <input
                            id="filter"
                            autocomplete="off"
                            placeholder="Digite para filtrar (ex.: U-03, S-11, Manu, Jonas, Noir‚Ä¶)"
                        />
                    </div>
                </div>
            </div>

            <div id="message" class="msg" style="display: none"></div>

            <div class="dash" id="dash" style="display: none">
                <!-- LEFT -->
                <div class="panel">
                    <div class="panel-head">
                        <div class="h">üåå UNIVERSOS + üìç ESPA√áOS</div>
                        <div class="meta" id="leftMeta"></div>
                    </div>

                    <div class="section">
                        <div class="section-title">
                            <div class="t">üåå UNIVERSOS</div>
                            <div class="count" id="uCount"></div>
                        </div>
                        <div class="rows" id="universes"></div>
                    </div>

                    <div class="section">
                        <div class="section-title">
                            <div class="t">üìç ESPA√áOS</div>
                            <div class="count" id="sCount"></div>
                        </div>
                        <div class="rows" id="spaces"></div>
                        <div
                            class="hint"
                            id="clusterHint"
                            style="display: none"
                        ></div>
                    </div>
                </div>

                <!-- RIGHT -->
                <div class="panel">
                    <div class="panel-head">
                        <div class="h">üë§ ATIVOS</div>
                        <div class="meta" id="rightMeta"></div>
                    </div>

                    <div class="section">
                        <div class="section-title">
                            <div class="t">üë§ ATIVOS DISPON√çVEIS</div>
                            <div class="count" id="aCount"></div>
                        </div>
                        <div class="rows" id="assets"></div>
                    </div>
                </div>
            </div>

            <div class="footer">
                GitHub Pages ¬∑ layout console ¬∑ fonte monospace ¬∑ cores sutis
                (ciano/azul/cinza)
            </div>
        </div>

        <script>
            const $ = (id) => document.getElementById(id);

            function showMsg(kind, html) {
                const el = $("message");
                el.className = "msg" + (kind === "error" ? " error" : "");
                el.innerHTML = html;
                el.style.display = "block";
            }

            function setStatus(text) {
                $("status").textContent = text;
            }

            function norm(s) {
                return (s ?? "")
                    .toString()
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "")
                    .toLowerCase();
            }

            function makeRow(id, name, extraBadge) {
                const row = document.createElement("div");
                row.className = "row";
                row.dataset.search = norm(`${id} ${name}`);

                const idEl = document.createElement("div");
                idEl.className = "id";
                idEl.textContent = id;

                const nameEl = document.createElement("div");
                nameEl.className = "name";
                nameEl.textContent = name;

                if (extraBadge) {
                    nameEl.appendChild(extraBadge);
                }

                row.appendChild(idEl);
                row.appendChild(nameEl);
                return row;
            }

            function badge(text, cls) {
                const b = document.createElement("span");
                b.className = `badge ${cls || ""}`.trim();
                b.textContent = text;
                return b;
            }

            async function loadJSON(path) {
                const r = await fetch(path, { cache: "no-store" });
                if (!r.ok) throw new Error(`${path} -> HTTP ${r.status}`);
                return await r.json();
            }

            function extractSpaces(spacesJSON) {
                // novo schema: { spaces: [...], clusters: [...] }
                if (spacesJSON && Array.isArray(spacesJSON.spaces))
                    return spacesJSON.spaces;
                // fallback legacy: lista direta
                if (Array.isArray(spacesJSON)) return spacesJSON;
                return [];
            }

            function extractClusters(spacesJSON) {
                if (spacesJSON && Array.isArray(spacesJSON.clusters))
                    return spacesJSON.clusters;
                return [];
            }

            function extractUniverses(universesJSON) {
                // pode ser { universes:[...] } ou lista
                if (universesJSON && Array.isArray(universesJSON.universes))
                    return universesJSON.universes;
                if (Array.isArray(universesJSON)) return universesJSON;
                return [];
            }

            function extractAssets(assetsJSON) {
                // 1) casos ‚Äúoficiais‚Äù
                if (assetsJSON && Array.isArray(assetsJSON.assets))
                    return assetsJSON.assets;
                if (Array.isArray(assetsJSON)) return assetsJSON;

                // 2) casos comuns (wrapper)
                const commonKeys = [
                    "items",
                    "data",
                    "list",
                    "actors",
                    "people",
                ];
                for (const k of commonKeys) {
                    if (assetsJSON && Array.isArray(assetsJSON[k]))
                        return assetsJSON[k];
                }

                // 3) heur√≠stica: procura a primeira Array dentro do objeto
                // que pare√ßa lista de assets
                if (assetsJSON && typeof assetsJSON === "object") {
                    for (const v of Object.values(assetsJSON)) {
                        if (Array.isArray(v) && v.length) {
                            const x = v[0];
                            if (x && typeof x === "object") {
                                const looksLikeAsset =
                                    "asset_id" in x ||
                                    ("nome" in x && "sobrenome" in x) ||
                                    ("name" in x && "surname" in x);
                                if (looksLikeAsset) return v;
                            }
                        }
                        // suporte a 1 n√≠vel de nesting: { catalog: { assets:[...] } }
                        if (v && typeof v === "object") {
                            for (const vv of Object.values(v)) {
                                if (Array.isArray(vv) && vv.length) {
                                    const x = vv[0];
                                    if (x && typeof x === "object") {
                                        const looksLikeAsset =
                                            "asset_id" in x ||
                                            ("nome" in x && "sobrenome" in x) ||
                                            ("name" in x && "surname" in x);
                                        if (looksLikeAsset) return vv;
                                    }
                                }
                            }
                        }
                    }
                }

                return [];
            }

            function byId(a, b) {
                // ordena√ß√£o por prefixo + n√∫mero (U-01, S-11, A-06‚Ä¶)
                const rx = /^([A-Z]+)-(\d+)/;
                const ma = rx.exec(a) || [];
                const mb = rx.exec(b) || [];
                const pa = ma[1] || a;
                const pb = mb[1] || b;
                if (pa !== pb) return pa.localeCompare(pb);
                const na = parseInt(ma[2] || "0", 10);
                const nb = parseInt(mb[2] || "0", 10);
                return na - nb;
            }

            function renderAll({ universes, spaces, clusters, assets }) {
                const uBox = $("universes");
                const sBox = $("spaces");
                const aBox = $("assets");

                uBox.innerHTML = "";
                sBox.innerHTML = "";
                aBox.innerHTML = "";

                // counts
                $("uCount").textContent = `${universes.length} itens`;
                $("sCount").textContent = `${spaces.length} itens`;
                $("aCount").textContent = `${assets.length} itens`;

                $("leftMeta").textContent = "catalog";
                $("rightMeta").textContent = "catalog";

                // Universes
                universes
                    .slice()
                    .sort((x, y) => byId(x.id || "", y.id || ""))
                    .forEach((u) => {
                        const uid = u.id || "";
                        const name = u.name || u.title || "(sem nome)";
                        // se tiver algum marcador de legacy (seu go.py detecta; aqui deixo opcional)
                        const b =
                            u.legacy === true ? badge("LEGACY", "w") : null;
                        uBox.appendChild(makeRow(uid, name, b));
                    });

                // Spaces
                const clusterIndex = new Map();
                clusters.forEach((c) => {
                    if (c && c.cluster_id) clusterIndex.set(c.cluster_id, c);
                    if (c && c.id) clusterIndex.set(c.id, c);
                });

                let anyCluster = false;

                spaces
                    .slice()
                    .sort((x, y) => byId(x.id || "", y.id || ""))
                    .forEach((s) => {
                        const sid = s.id || "";
                        const name = s.name || "(sem nome)";

                        let b = null;
                        const bind = s.cluster_binding;
                        if (bind && bind.cluster_id) {
                            const c = clusterIndex.get(bind.cluster_id);
                            const label = c?.name
                                ? `C ${c.name}`
                                : `C ${bind.cluster_id}`;
                            b = badge(label, "c");
                            anyCluster = true;
                        }
                        sBox.appendChild(makeRow(sid, name, b));
                    });

                if (anyCluster) {
                    const hint = $("clusterHint");
                    hint.style.display = "block";
                    hint.textContent =
                        "Clusters aparecem como badges (contratos herdados) ‚Äî n√£o s√£o execut√°veis.";
                } else {
                    $("clusterHint").style.display = "none";
                }

                // Assets
                assets
                    .slice()
                    .sort((x, y) =>
                        byId(
                            x.asset_id || x.id || "",
                            y.asset_id || y.id || "",
                        ),
                    )
                    .forEach((a) => {
                        const aid = a.asset_id || a.id || "";
                        const full =
                            `${a.nome || ""} ${a.sobrenome || ""}`.trim() ||
                            "(sem nome)";
                        aBox.appendChild(makeRow(aid, full));
                    });

                // filter binding
                const filter = $("filter");
                const applyFilter = () => {
                    const q = norm(filter.value);
                    const rows = document.querySelectorAll(".row");
                    rows.forEach((r) => {
                        const ok = !q || (r.dataset.search || "").includes(q);
                        r.style.display = ok ? "" : "none";
                    });
                };
                filter.addEventListener("input", applyFilter);
            }

            async function init() {
                try {
                    setStatus("LOADING");
                    showMsg(
                        "",
                        `<b>Carregando</b> assets.json ¬∑ spaces.json ¬∑ universes.json ‚Ä¶`,
                    );

                    const [assetsJSON, spacesJSON, universesJSON] =
                        await Promise.all([
                            loadJSON("./assets.json"),
                            loadJSON("./spaces.json"),
                            loadJSON("./universes.json"),
                        ]);

                    const assets = extractAssets(assetsJSON);
                    const spaces = extractSpaces(spacesJSON);
                    const clusters = extractClusters(spacesJSON);
                    const universes = extractUniverses(universesJSON);

                    // sanity check b√°sico
                    if (!assets.length && !spaces.length && !universes.length) {
                        throw new Error(
                            "Nenhum dado carregado (JSONs vazios ou formato inesperado).",
                        );
                    }

                    $("message").style.display = "none";
                    $("dash").style.display = "grid";

                    renderAll({ universes, spaces, clusters, assets });
                    setStatus("READY");
                } catch (err) {
                    setStatus("ERROR");
                    showMsg(
                        "error",
                        `<b>Erro ao carregar dados.</b><br><br>
           ${String(err.message || err)}<br><br>
           Verifique se <code>assets.json</code>, <code>spaces.json</code> e <code>universes.json</code> est√£o na raiz do repo e acess√≠veis pelo Pages.`,
                    );
                }
            }

            init();
        </script>
    </body>
</html>
