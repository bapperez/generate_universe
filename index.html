<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>MATRIX :: CONSOLE</title>

        <style>
            :root {
                --bg: #0b0e14;
                --text: #d7dde8;
                --muted: #8b93a7;

                /* ANSI sutis */
                --cyan: #58c7d7;
                --blue: #6aa6ff;
                --gray: #9aa3b5;

                --good: #73e6c7;
                --warn: #ffcf5a;
                --bad: #ff6b86;

                --line: #1d2940;
                --line2: #142033;

                --mono:
                    ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
                    "Liberation Mono", monospace;
                --sans:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Helvetica, Arial, sans-serif;

                --sel: rgba(106, 166, 255, 0.16);
                --selBorder: rgba(106, 166, 255, 0.45);
                --selGlow: rgba(106, 166, 255, 0.2);

                --tagBg: rgba(255, 255, 255, 0.04);
                --tagBd: rgba(255, 255, 255, 0.09);

                --btnBg: rgba(88, 199, 215, 0.12);
                --btnBd: rgba(88, 199, 215, 0.26);
                --btnBg2: rgba(106, 166, 255, 0.12);
                --btnBd2: rgba(106, 166, 255, 0.26);
            }

            * {
                box-sizing: border-box;
            }
            html,
            body {
                height: 100%;
            }
            body {
                margin: 0;
                background: radial-gradient(
                    1200px 600px at 20% 0%,
                    #0f1626 0%,
                    var(--bg) 60%
                );
                color: var(--text);
                font-family: var(--mono);
                letter-spacing: 0.2px;
            }

            .wrap {
                max-width: 1100px;
                margin: 28px auto 92px;
                padding: 0 18px;
            }

            /* Header */
            .header-box {
                border: 1px solid var(--line);
                border-radius: 12px;
                background: linear-gradient(
                    180deg,
                    rgba(255, 255, 255, 0.03),
                    rgba(255, 255, 255, 0.01)
                );
                padding: 14px 16px;
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
            }

            .header-top {
                display: flex;
                gap: 12px;
                align-items: center;
                justify-content: space-between;
                flex-wrap: wrap;
            }

            .brand {
                display: flex;
                align-items: baseline;
                gap: 10px;
                min-width: 260px;
            }
            .brand .title {
                font-weight: 700;
                color: var(--cyan);
                font-size: 14px;
                letter-spacing: 1.2px;
            }
            .brand .subtitle {
                color: var(--muted);
                font-size: 12px;
                font-family: var(--sans);
            }

            .statusline {
                display: flex;
                gap: 14px;
                flex-wrap: wrap;
                font-size: 12px;
                color: var(--gray);
            }
            .pill {
                border: 1px solid var(--line2);
                background: rgba(88, 199, 215, 0.06);
                padding: 6px 10px;
                border-radius: 999px;
                display: flex;
                gap: 6px;
                align-items: center;
            }
            .pill b {
                color: var(--text);
                font-weight: 600;
            }
            .dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--good);
                box-shadow: 0 0 12px rgba(115, 230, 199, 0.35);
            }

            .controls {
                margin-top: 12px;
                display: flex;
                gap: 12px;
                flex-wrap: wrap;
                align-items: center;
            }
            .control {
                display: flex;
                gap: 8px;
                align-items: center;
                border: 1px solid var(--line2);
                background: rgba(255, 255, 255, 0.02);
                border-radius: 10px;
                padding: 10px 12px;
                flex: 1 1 320px;
                min-width: 240px;
            }
            .control label {
                color: var(--muted);
                font-size: 12px;
                font-family: var(--sans);
                white-space: nowrap;
            }
            .control input {
                width: 100%;
                background: transparent;
                border: none;
                outline: none;
                color: var(--text);
                font-family: var(--mono);
                font-size: 13px;
            }

            /* Dashboard layout */
            .dash {
                margin-top: 18px;
                display: grid;
                grid-template-columns: 1.12fr 0.88fr;
                gap: 16px;
            }
            @media (max-width: 860px) {
                .dash {
                    grid-template-columns: 1fr;
                }
            }

            .panel {
                border: 1px solid var(--line);
                border-radius: 12px;
                background: rgba(15, 21, 33, 0.65);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.28);
                overflow: hidden;
            }
            .panel .panel-head {
                padding: 12px 14px;
                border-bottom: 1px solid var(--line2);
                background: rgba(12, 17, 27, 0.7);
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 10px;
            }
            .panel .panel-head .h {
                color: var(--cyan);
                font-weight: 700;
                letter-spacing: 0.8px;
                font-size: 13px;
            }
            .panel .panel-head .meta {
                color: var(--muted);
                font-size: 12px;
                font-family: var(--sans);
            }

            .section {
                padding: 10px 14px 14px;
            }
            .section + .section {
                border-top: 1px dashed rgba(29, 41, 64, 0.7);
                padding-top: 12px;
            }
            .section-title {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 10px;
                margin: 2px 0 10px;
            }
            .section-title .t {
                color: var(--blue);
                font-weight: 700;
                font-size: 13px;
                letter-spacing: 0.6px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .section-title .count {
                color: var(--muted);
                font-size: 12px;
                font-family: var(--sans);
            }

            /* rows */
            .rows {
                display: flex;
                flex-direction: column;
                gap: 6px;
            }
            .row {
                user-select: none;
                cursor: pointer;
                display: block;
                padding: 9px 10px;
                border-radius: 10px;
                border: 1px solid transparent;
                background: rgba(255, 255, 255, 0.01);
                transition:
                    background 0.12s ease,
                    border-color 0.12s ease,
                    box-shadow 0.12s ease;
            }
            .row:hover {
                border-color: rgba(106, 166, 255, 0.25);
                background: rgba(106, 166, 255, 0.06);
            }
            .row.selected {
                border-color: var(--selBorder);
                background: var(--sel);
                box-shadow:
                    0 0 0 1px rgba(106, 166, 255, 0.15) inset,
                    0 0 22px var(--selGlow);
            }
            .name {
                color: var(--text);
                font-family: var(--sans);
                font-size: 13px;
                line-height: 1.25;
            }

            .badge {
                display: inline-flex;
                gap: 6px;
                align-items: center;
                font-size: 11px;
                font-family: var(--sans);
                color: rgba(215, 221, 232, 0.9);
                border: 1px solid rgba(255, 255, 255, 0.08);
                background: rgba(255, 255, 255, 0.03);
                padding: 3px 8px;
                border-radius: 999px;
                margin-left: 8px;
                vertical-align: middle;
                white-space: nowrap;
            }
            .badge.c {
                border-color: rgba(88, 199, 215, 0.2);
                background: rgba(88, 199, 215, 0.1);
                color: rgba(180, 240, 248, 0.95);
            }

            .hint {
                margin-top: 10px;
                color: var(--muted);
                font-family: var(--sans);
                font-size: 12px;
            }

            /* Action bar */
            .actionbar {
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
                padding: 12px 14px;
                background: rgba(10, 14, 20, 0.82);
                backdrop-filter: blur(10px);
                border-top: 1px solid rgba(29, 41, 64, 0.65);
                box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.35);
            }
            .actionbar-inner {
                max-width: 1100px;
                margin: 0 auto;
                display: flex;
                gap: 12px;
                align-items: center;
                justify-content: space-between;
                flex-wrap: wrap;
                padding: 0 8px;
            }

            .summary {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                align-items: center;
                font-family: var(--sans);
                font-size: 12px;
                color: var(--muted);
            }
            .tag {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                border: 1px solid var(--tagBd);
                background: var(--tagBg);
                color: rgba(215, 221, 232, 0.95);
                padding: 6px 10px;
                border-radius: 999px;
                font-family: var(--mono);
                font-size: 12px;
                letter-spacing: 0.1px;
                white-space: nowrap;
            }
            .tag .k {
                color: var(--gray);
                font-weight: 700;
            }
            .tag .v {
                color: var(--text);
                font-weight: 600;
            }

            .btns {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                align-items: center;
            }
            .btn {
                cursor: pointer;
                border-radius: 12px;
                padding: 10px 12px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                background: rgba(255, 255, 255, 0.04);
                color: var(--text);
                font-family: var(--sans);
                font-weight: 600;
                font-size: 13px;
                letter-spacing: 0.2px;
                display: inline-flex;
                align-items: center;
                gap: 8px;
                transition:
                    transform 0.06s ease,
                    background 0.12s ease,
                    border-color 0.12s ease;
            }
            .btn:active {
                transform: translateY(1px);
            }
            .btn.primary {
                border-color: var(--btnBd2);
                background: var(--btnBg2);
            }
            .btn.secondary {
                border-color: var(--btnBd);
                background: var(--btnBg);
            }
            .btn:disabled {
                cursor: not-allowed;
                opacity: 0.45;
            }

            .toast {
                position: fixed;
                right: 14px;
                bottom: 78px;
                max-width: 420px;
                border: 1px solid rgba(29, 41, 64, 0.75);
                background: rgba(15, 21, 33, 0.88);
                border-radius: 12px;
                padding: 10px 12px;
                color: rgba(215, 221, 232, 0.95);
                font-family: var(--sans);
                font-size: 12px;
                box-shadow: 0 14px 40px rgba(0, 0, 0, 0.45);
                display: none;
            }
            .toast b {
                color: var(--good);
            }

            /* Loading / error */
            .msg {
                margin-top: 16px;
                border: 1px solid var(--line);
                border-radius: 12px;
                padding: 14px 16px;
                background: rgba(15, 21, 33, 0.5);
                font-family: var(--sans);
                color: var(--muted);
            }
            .msg b {
                color: var(--text);
            }
            .msg.error {
                border-color: rgba(255, 107, 134, 0.25);
            }
            .msg.error b {
                color: var(--bad);
            }
        </style>
    </head>

    <body>
        <div class="wrap">
            <div class="header-box">
                <div class="header-top">
                    <div class="brand">
                        <div class="title">MATRIX :: CONSOLE</div>
                        <div class="subtitle">
                            dashboard (web) ¬∑ sele√ß√£o ‚Üí gerar prompt ‚Üí copiar
                        </div>
                    </div>

                    <div class="statusline">
                        <div class="pill">
                            <span class="dot"></span> <span>STATUS:</span>
                            <b id="status">LOADING</b>
                        </div>
                        <div class="pill">
                            <span>MODE:</span> <b id="mode">SELECTOR</b>
                        </div>
                        <div class="pill">
                            <span>VERSION:</span> <b id="version">web-2.0</b>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <div class="control">
                        <label for="filter">Filtro</label>
                        <input
                            id="filter"
                            autocomplete="off"
                            placeholder="Filtrar (ex.: U-03, S-11, Manu, Jonas, Noir‚Ä¶)"
                        />
                    </div>
                </div>
            </div>

            <div id="message" class="msg" style="display: none"></div>

            <div class="dash" id="dash" style="display: none">
                <!-- LEFT -->
                <div class="panel">
                    <div class="panel-head">
                        <div class="h">üåå UNIVERSOS + üìç ESPA√áOS</div>
                        <div class="meta">selecione 1 (universo OU espa√ßo)</div>
                    </div>

                    <div class="section">
                        <div class="section-title">
                            <div class="t">üåå UNIVERSOS</div>
                            <div class="count" id="uCount"></div>
                        </div>
                        <div class="rows" id="universes"></div>
                    </div>

                    <div class="section">
                        <div class="section-title">
                            <div class="t">üìç ESPA√áOS</div>
                            <div class="count" id="sCount"></div>
                        </div>
                        <div class="rows" id="spaces"></div>
                        <div
                            class="hint"
                            id="clusterHint"
                            style="display: none"
                        ></div>
                    </div>
                </div>

                <!-- RIGHT -->
                <div class="panel">
                    <div class="panel-head">
                        <div class="h">üë§ ATIVOS</div>
                        <div class="meta">selecione quantos quiser</div>
                    </div>

                    <div class="section">
                        <div class="section-title">
                            <div class="t">üë§ ATIVOS DISPON√çVEIS</div>
                            <div class="count" id="aCount"></div>
                        </div>
                        <div class="rows" id="assets"></div>
                        <div class="hint">
                            Dica: 1 ativo ‚Üí solo ¬∑ 2+ ativos ‚Üí duo (varia√ß√£o
                            inferida quando existir cluster).
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action bar -->
        <div class="actionbar">
            <div class="actionbar-inner">
                <div class="summary" id="summary">
                    <span class="tag"
                        ><span class="k">Left</span>
                        <span class="v" id="sumLeft">‚Äî</span></span
                    >
                    <span class="tag"
                        ><span class="k">Assets</span>
                        <span class="v" id="sumAssets">0</span></span
                    >
                </div>

                <div class="btns">
                    <button class="btn" id="btnClear" type="button">
                        üßπ Limpar
                    </button>
                    <button
                        class="btn secondary"
                        id="btnPreview"
                        type="button"
                        disabled
                    >
                        üëÅÔ∏è Pr√©via
                    </button>
                    <button
                        class="btn primary"
                        id="btnGenerate"
                        type="button"
                        disabled
                    >
                        ‚ö° Gerar + Copiar
                    </button>
                </div>
            </div>
        </div>

        <div class="toast" id="toast"></div>

        <script>
            const $ = (id) => document.getElementById(id);

            let DATA = {
                universes: [],
                spaces: [],
                clusters: [],
                assets: [],
            };

            // selection state
            let selectedUniverseId = null;
            let selectedSpaceId = null;
            let selectedAssetIds = new Set();

            let lastPrompt = "";

            function toast(html) {
                const el = $("toast");
                el.innerHTML = html;
                el.style.display = "block";
                clearTimeout(toast._t);
                toast._t = setTimeout(() => {
                    el.style.display = "none";
                }, 2600);
            }

            function showMsg(kind, html) {
                const el = $("message");
                el.className = "msg" + (kind === "error" ? " error" : "");
                el.innerHTML = html;
                el.style.display = "block";
            }

            function setStatus(text) {
                $("status").textContent = text;
            }

            function norm(s) {
                return (s ?? "")
                    .toString()
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "")
                    .toLowerCase();
            }

            function badge(text, cls) {
                const b = document.createElement("span");
                b.className = `badge ${cls || ""}`.trim();
                b.textContent = text;
                return b;
            }
            function byName(aName, aId, bName, bId) {
                const an = norm(aName || "");
                const bn = norm(bName || "");
                if (an && bn && an !== bn) return an.localeCompare(bn);
                if (an && !bn) return -1;
                if (!an && bn) return 1;
                return String(aId || "").localeCompare(String(bId || ""));
            }

            function byId(a, b) {
                const rx = /^([A-Z]+)-(\d+)/;
                const ma = rx.exec(a) || [];
                const mb = rx.exec(b) || [];
                const pa = ma[1] || a;
                const pb = mb[1] || b;
                if (pa !== pb) return pa.localeCompare(pb);
                const na = parseInt(ma[2] || "0", 10);
                const nb = parseInt(mb[2] || "0", 10);
                return na - nb;
            }

            async function loadJSON(path) {
                const r = await fetch(path, { cache: "no-store" });
                if (!r.ok) throw new Error(`${path} -> HTTP ${r.status}`);
                return await r.json();
            }

            function extractSpaces(spacesJSON) {
                if (spacesJSON && Array.isArray(spacesJSON.spaces))
                    return spacesJSON.spaces;
                if (Array.isArray(spacesJSON)) return spacesJSON;
                return [];
            }

            function extractClusters(spacesJSON) {
                if (spacesJSON && Array.isArray(spacesJSON.clusters))
                    return spacesJSON.clusters;
                return [];
            }

            function extractUniverses(universesJSON) {
                if (universesJSON && Array.isArray(universesJSON.universes))
                    return universesJSON.universes;
                if (Array.isArray(universesJSON)) return universesJSON;
                return [];
            }

            // extractor el√°stico (n√£o engessa schema)
            function extractAssets(assetsJSON) {
                if (assetsJSON && Array.isArray(assetsJSON.assets))
                    return assetsJSON.assets;
                if (Array.isArray(assetsJSON)) return assetsJSON;

                const commonKeys = [
                    "items",
                    "data",
                    "list",
                    "people",
                    "actors",
                ];
                for (const k of commonKeys) {
                    if (assetsJSON && Array.isArray(assetsJSON[k]))
                        return assetsJSON[k];
                }

                if (assetsJSON && typeof assetsJSON === "object") {
                    for (const v of Object.values(assetsJSON)) {
                        if (
                            Array.isArray(v) &&
                            v.length &&
                            typeof v[0] === "object"
                        ) {
                            const x = v[0];
                            if (
                                "asset_id" in x ||
                                ("nome" in x && "sobrenome" in x)
                            )
                                return v;
                        }
                        if (v && typeof v === "object") {
                            for (const vv of Object.values(v)) {
                                if (
                                    Array.isArray(vv) &&
                                    vv.length &&
                                    typeof vv[0] === "object"
                                ) {
                                    const x = vv[0];
                                    if (
                                        "asset_id" in x ||
                                        ("nome" in x && "sobrenome" in x)
                                    )
                                        return vv;
                                }
                            }
                        }
                    }
                }
                return [];
            }

            function makeRow({
                id,
                name,
                search,
                extraBadge,
                onClick,
                selected = false,
            }) {
                const row = document.createElement("div");
                row.className = "row" + (selected ? " selected" : "");
                row.dataset.search = norm(search || `${id} ${name}`);
                row.dataset.id = id;

                const nameEl = document.createElement("div");
                nameEl.className = "name";
                nameEl.textContent = name;

                if (extraBadge) nameEl.appendChild(extraBadge);

                row.appendChild(nameEl);

                row.addEventListener("click", onClick);
                row.addEventListener("touchstart", () => {}, { passive: true });
                return row;
            }

            function updateSummary() {
                const left = selectedUniverseId
                    ? selectedUniverseId
                    : selectedSpaceId
                      ? selectedSpaceId
                      : "‚Äî";
                $("sumLeft").textContent = left;
                $("sumAssets").textContent = String(selectedAssetIds.size);

                const hasSomething = Boolean(
                    selectedUniverseId ||
                    selectedSpaceId ||
                    selectedAssetIds.size,
                );
                $("btnGenerate").disabled = !hasSomething;
                $("btnPreview").disabled = !hasSomething;
            }

            function applyFilter() {
                const q = norm($("filter").value);
                document.querySelectorAll(".row").forEach((r) => {
                    const ok = !q || (r.dataset.search || "").includes(q);
                    r.style.display = ok ? "" : "none";
                });
            }

            function clearSelection() {
                selectedUniverseId = null;
                selectedSpaceId = null;
                selectedAssetIds = new Set();

                // remove selected class from all
                document
                    .querySelectorAll(".row.selected")
                    .forEach((r) => r.classList.remove("selected"));
                lastPrompt = "";
                updateSummary();
                toast(
                    `<b>Limpo.</b> Selecione um universo/espa√ßo e os ativos.`,
                );
            }

            function selectUniverse(uid) {
                selectedUniverseId = uid;
                selectedSpaceId = null;

                // visual: clear left selections, set this one
                document
                    .querySelectorAll("#universes .row, #spaces .row")
                    .forEach((r) => r.classList.remove("selected"));
                const row = document.querySelector(
                    `#universes .row[data-id="${CSS.escape(uid)}"]`,
                );
                if (row) row.classList.add("selected");
                updateSummary();
            }

            function selectSpace(sid) {
                selectedSpaceId = sid;
                selectedUniverseId = null;

                document
                    .querySelectorAll("#universes .row, #spaces .row")
                    .forEach((r) => r.classList.remove("selected"));
                const row = document.querySelector(
                    `#spaces .row[data-id="${CSS.escape(sid)}"]`,
                );
                if (row) row.classList.add("selected");
                updateSummary();
            }

            function toggleAsset(aid) {
                if (selectedAssetIds.has(aid)) selectedAssetIds.delete(aid);
                else selectedAssetIds.add(aid);

                const row = document.querySelector(
                    `#assets .row[data-id="${CSS.escape(aid)}"]`,
                );
                if (row)
                    row.classList.toggle("selected", selectedAssetIds.has(aid));
                updateSummary();
            }

            function getUniverseById(id) {
                return (
                    DATA.universes.find(
                        (u) => (u.id || u.universe_id) === id,
                    ) || null
                );
            }
            function getSpaceById(id) {
                return DATA.spaces.find((s) => s.id === id) || null;
            }
            function getAssetById(id) {
                return (
                    DATA.assets.find((a) => (a.asset_id || a.id) === id) || null
                );
            }
            function buildClusterIndex() {
                const idx = new Map();
                for (const c of DATA.clusters) {
                    if (!c) continue;
                    if (c.cluster_id) idx.set(c.cluster_id, c);
                    if (c.id) idx.set(c.id, c);
                }
                return idx;
            }

            // ---------- Prompt builder (el√°stico) ----------
            function line(...xs) {
                return xs.filter(Boolean).join("");
            }
            function titleBlock(kind, name) {
                return `MATRIX ‚Äî PROMPT GERADOR (${kind})\n\n## ${kind}\n\n**${name || "‚Äî"}**\n`;
            }

            function pick(obj, keys) {
                for (const k of keys) {
                    if (
                        obj &&
                        obj[k] !== undefined &&
                        obj[k] !== null &&
                        obj[k] !== ""
                    )
                        return obj[k];
                }
                return null;
            }

            function bulletsFromArray(arr) {
                if (!Array.isArray(arr) || !arr.length) return "";
                return arr.map((x) => `- ${String(x)}`).join("\n") + "\n";
            }

            function describeUniverse(u) {
                // escreve s√≥ o que existe
                const name = pick(u, ["name", "title"]) || u.id || "Universo";
                let out = titleBlock("UNIVERSO", name) + "\n";

                const metaPairs = [
                    ["id", pick(u, ["id", "universe_id"])],
                    [
                        "classifica√ß√£o",
                        pick(u, ["classification", "class", "tier"]),
                    ],
                    ["g√™nero", pick(u, ["genre"])],
                    ["tom", pick(u, ["tone"])],
                    ["√©poca", pick(u, ["era", "year", "timeframe"])],
                    ["localiza√ß√£o", pick(u, ["location", "setting"])],
                    ["pol√≠tica temporal", pick(u, ["temporal_policy"])],
                    ["pol√≠tica de mem√≥ria", pick(u, ["memory_policy"])],
                ].filter(([_, v]) => v);

                if (metaPairs.length) {
                    out += "## METADADOS\n\n";
                    out +=
                        metaPairs.map(([k, v]) => `- ${k}: ${v}`).join("\n") +
                        "\n\n";
                }

                const premise = pick(u, [
                    "premise",
                    "premissa",
                    "logline",
                    "one_liner",
                    "description",
                    "descricao",
                ]);
                if (premise) {
                    out += "## PREMISSA\n\n" + premise + "\n\n";
                }

                const laws = pick(u, ["laws", "rules", "leis", "regras"]);
                if (Array.isArray(laws)) {
                    out +=
                        "## LEIS / REGRAS DO MUNDO\n\n" +
                        bulletsFromArray(laws) +
                        "\n";
                } else if (typeof laws === "string") {
                    out += "## LEIS / REGRAS DO MUNDO\n\n" + laws + "\n\n";
                }

                const safety = pick(u, [
                    "safety_envelope",
                    "safety",
                    "envelope",
                ]);
                if (safety) {
                    out += "## SAFETY ENVELOPE\n\n";
                    if (typeof safety === "string") out += safety + "\n\n";
                    else {
                        // escreve de forma humana
                        const keys = Object.keys(safety);
                        for (const k of keys) {
                            const v = safety[k];
                            if (Array.isArray(v))
                                out += `- ${k}:\n${v.map((x) => `  - ${x}`).join("\n")}\n`;
                            else out += `- ${k}: ${String(v)}\n`;
                        }
                        out += "\n";
                    }
                }

                out += "## DIRE√á√ÉO CRIATIVA (liberdade do Gemini)\n\n";
                out +=
                    [
                        "- Use as informa√ß√µes como base e expanda com criatividade, sem travar em formato.",
                        "- Voc√™ pode criar espa√ßos, detalhes, NPCs e din√¢mica social quando necess√°rio para o mundo funcionar.",
                        "- Continuidade pode ser local ao chat; um novo prompt redefine o setup.",
                        "- N√£o liste IDs/c√≥digos no texto. Trate tudo como descri√ß√£o humana e visual.",
                    ].join("\n") + "\n\n";

                return out.trim() + "\n";
            }

            function describeSpace(s, clusterCtx) {
                const name = s?.name || s?.title || s?.id || "Espa√ßo";
                let out = titleBlock("ESPA√áO", name) + "\n";

                const metaPairs = [
                    ["id", s?.id],
                    ["tipo", pick(s, ["type", "kind"])],
                    ["modo", pick(s, ["mode"])],
                    ["intera√ß√£o do usu√°rio", pick(s, ["user_interaction"])],
                ].filter(([_, v]) => v);

                if (metaPairs.length) {
                    out +=
                        "## METADADOS\n\n" +
                        metaPairs.map(([k, v]) => `- ${k}: ${v}`).join("\n") +
                        "\n\n";
                }

                if (clusterCtx) {
                    out += `## CLUSTER (contrato transversal)\n\n`;
                    out += `- cluster: ${clusterCtx.name || clusterCtx.id}\n`;
                    if (clusterCtx.variation)
                        out += `- varia√ß√£o inferida: ${clusterCtx.variation}\n`;
                    out += "\n";

                    const contract = clusterCtx.contract;
                    if (contract) {
                        if (
                            Array.isArray(contract.core_principles) &&
                            contract.core_principles.length
                        ) {
                            out +=
                                "### Princ√≠pios\n\n" +
                                bulletsFromArray(contract.core_principles) +
                                "\n";
                        }
                        if (
                            Array.isArray(contract.forbidden_outcomes) &&
                            contract.forbidden_outcomes.length
                        ) {
                            out +=
                                "### Proibido\n\n" +
                                bulletsFromArray(contract.forbidden_outcomes) +
                                "\n";
                        }
                        if (
                            contract.execution_requirements &&
                            typeof contract.execution_requirements === "object"
                        ) {
                            out += "### Requisitos m√≠nimos\n\n";
                            for (const [k, v] of Object.entries(
                                contract.execution_requirements,
                            )) {
                                if (Array.isArray(v))
                                    out += `- ${k}:\n${v.map((x) => `  - ${x}`).join("\n")}\n`;
                                else out += `- ${k}: ${String(v)}\n`;
                            }
                            out += "\n";
                        }
                    }

                    const varDesc = clusterCtx.variation_descriptions;
                    if (
                        varDesc &&
                        clusterCtx.variation &&
                        varDesc[clusterCtx.variation]
                    ) {
                        out += "### Dire√ß√£o de varia√ß√£o\n\n";
                        const vd = varDesc[clusterCtx.variation];
                        if (typeof vd === "string") out += vd + "\n\n";
                        else if (vd && typeof vd === "object") {
                            for (const [k, v] of Object.entries(vd)) {
                                out += `- ${k}: ${String(v)}\n`;
                            }
                            out += "\n";
                        }
                    }
                }

                const objects = pick(s, ["objects", "objetos"]);
                if (Array.isArray(objects) && objects.length) {
                    out +=
                        "## OBJETOS / AMBIENTE\n\n" +
                        bulletsFromArray(objects) +
                        "\n";
                }

                const rules = pick(s, ["rules", "regras"]);
                if (Array.isArray(rules) && rules.length) {
                    out +=
                        "## REGRAS LOCAIS\n\n" + bulletsFromArray(rules) + "\n";
                }

                // Campos sem√¢nticos novos (se existirem)
                const semKeys = [
                    "biomechanics",
                    "balance_model",
                    "leverage_model",
                    "wardrobe_policy",
                    "erotization_level",
                    "variation_descriptions",
                ];
                const anySem = semKeys.some((k) => s && s[k] !== undefined);
                if (anySem) {
                    out += "## PAR√ÇMETROS SEM√ÇNTICOS\n\n";
                    for (const k of semKeys) {
                        const v = s[k];
                        if (v === undefined || v === null) continue;
                        if (typeof v === "object") {
                            out += `- ${k}:\n`;
                            if (Array.isArray(v))
                                out +=
                                    v.map((x) => `  - ${x}`).join("\n") + "\n";
                            else
                                out +=
                                    Object.entries(v)
                                        .map(
                                            ([kk, vv]) =>
                                                `  - ${kk}: ${String(vv)}`,
                                        )
                                        .join("\n") + "\n";
                        } else {
                            out += `- ${k}: ${String(v)}\n`;
                        }
                    }
                    out += "\n";
                }

                out += "## DIRE√á√ÉO CRIATIVA (liberdade do Gemini)\n\n";
                out +=
                    [
                        "- Execute o espa√ßo acima como √¢ncora, mas deixe a cena viva e funcional.",
                        "- Voc√™ pode inventar detalhes de cen√°rio, ilumina√ß√£o, som, ritmo e micro-acontecimentos.",
                        "- Continuidade local ao chat √© permitida; reset s√≥ por novo prompt/chat.",
                        "- N√£o liste IDs/c√≥digos no texto.",
                    ].join("\n") + "\n\n";

                return out.trim() + "\n";
            }

            function describeAssets(selectedAssets) {
                let out = "## ATIVOS PRESENTES\n\n";
                for (const a of selectedAssets) {
                    const full =
                        `${a.nome || ""} ${a.sobrenome || ""}`.trim() ||
                        a.asset_id ||
                        a.id ||
                        "Ativo";
                    const birth = pick(a, ["data_nascimento", "nascimento"]);
                    const idade = pick(a, ["idade"]);
                    const signo = pick(a, ["signo"]);
                    const altura = pick(a, ["altura_cm"]);
                    const peso = pick(a, ["peso_kg"]);

                    const hair = pick(a, ["cor_cabelo"]);
                    const cut = pick(a, ["corte_penteado"]);
                    const skin = pick(a, ["cor_pele"]);
                    const eyes = pick(a, ["cor_olhos"]);

                    const body = pick(a, ["estrutura_corpo"]);
                    const fat = pick(a, ["tecido_adiposo"]);
                    const mus = pick(a, ["musculatura"]);

                    const persona = pick(a, ["personalidade"]);
                    const asc = pick(a, ["ascendente"]);
                    const ascConf = pick(a, [
                        "ascendente_confianca",
                        "ascendente_confidence",
                    ]);

                    out += `- **${full}** ‚Äî `;
                    const bits = [];
                    if (birth) bits.push(`nascimento ${birth}`);
                    if (idade !== null && idade !== undefined)
                        bits.push(`idade ${idade}`);
                    if (signo) bits.push(`signo ${signo}`);
                    if (altura) bits.push(`altura ${altura} cm`);
                    if (peso) bits.push(`peso ${peso} kg`);
                    if (bits.length) out += `Dados: ${bits.join("; ")}. `;

                    const ap = [];
                    if (hair) ap.push(`cabelo ${hair}`);
                    if (cut) ap.push(`corte ${cut}`);
                    if (skin) ap.push(`pele ${skin}`);
                    if (eyes) ap.push(`olhos ${eyes}`);
                    if (ap.length) out += `Apar√™ncia: ${ap.join("; ")}. `;

                    const cb = [];
                    if (body) cb.push(body);
                    if (fat !== null && fat !== undefined)
                        cb.push(`tecido adiposo ${fat}/100`);
                    if (mus !== null && mus !== undefined)
                        cb.push(`musculatura ${mus}/100`);
                    if (cb.length) out += `Corpo: ${cb.join("; ")}. `;

                    const pp = [];
                    if (persona) pp.push(persona);
                    if (asc) {
                        const confTxt =
                            ascConf !== null && ascConf !== undefined
                                ? ` (conf. ${ascConf})`
                                : "";
                        pp.push(`ascendente ${asc}${confTxt}`);
                    }
                    if (pp.length) out += `Personalidade: ${pp.join("; ")}. `;

                    out +=
                        "Vestu√°rio: marcas premium e bonitas, escolhidas livremente conforme o contexto (figurino responde ao ambiente).\n";
                }
                out += "\n";
                return out;
            }

            function buildPrompt() {
                const selectedAssets = Array.from(selectedAssetIds)
                    .map((id) => getAssetById(id))
                    .filter(Boolean);

                const hasU = Boolean(selectedUniverseId);
                const hasS = Boolean(selectedSpaceId);
                const hasA = selectedAssets.length > 0;

                // Mode decisions (igual ao go.py, sem exigir ordem)
                if (hasU) {
                    const u = getUniverseById(selectedUniverseId);
                    let out =
                        "MATRIX ‚Äî PROMPT GERADOR (UNIVERSO" +
                        (hasA ? " + ATIVOS" : "") +
                        ")\n\n";
                    out += "## UNIVERSO ATIVO\n\n";
                    out += `**${(u && (u.name || u.title)) || selectedUniverseId}**\n\n`;
                    // universo detalhado
                    if (u) out += describeUniverse(u) + "\n";
                    if (hasA) out += describeAssets(selectedAssets);

                    out += "## DIRE√á√ÉO CRIATIVA (liberdade do Gemini)\n\n";
                    out +=
                        [
                            "- Use o universo como regra de mundo; crie espa√ßos e cenas livremente para o mundo funcionar.",
                            "- N√£o trave em formato. Priorize impacto, ritmo e decis√µes concretas.",
                            "- Continuidade local ao chat √© permitida; reset por novo prompt/chat.",
                            "- N√£o liste IDs/c√≥digos no texto.",
                        ].join("\n") + "\n";
                    return out.trim() + "\n";
                }

                if (hasS) {
                    const s = getSpaceById(selectedSpaceId);
                    const clusterIndex = buildClusterIndex();
                    let clusterCtx = null;

                    if (
                        s &&
                        s.cluster_binding &&
                        s.cluster_binding.cluster_id
                    ) {
                        const cid = s.cluster_binding.cluster_id;
                        const c = clusterIndex.get(cid);

                        if (
                            s.cluster_binding.requires_cluster_validation &&
                            !c
                        ) {
                            throw new Error(
                                `Space ${s.id} exige cluster ${cid}, mas o cluster n√£o existe.`,
                            );
                        }

                        if (c) {
                            const variation = hasA
                                ? selectedAssets.length >= 2
                                    ? "duo"
                                    : "solo"
                                : null;
                            clusterCtx = {
                                id: cid,
                                name: c.name || cid,
                                contract: c.contract || null,
                                variation,
                                variation_descriptions:
                                    c.variations ||
                                    c.variation_descriptions ||
                                    null,
                            };
                        }
                    }

                    let out =
                        "MATRIX ‚Äî PROMPT GERADOR (ESPA√áO" +
                        (hasA ? " + ATIVOS" : "") +
                        ")\n\n";
                    out += "## ESPA√áO ATIVO\n\n";
                    out += `**${(s && s.name) || selectedSpaceId}**\n\n`;
                    if (s) out += describeSpace(s, clusterCtx) + "\n";
                    if (hasA) out += describeAssets(selectedAssets);

                    out += "## DIRE√á√ÉO CRIATIVA (liberdade do Gemini)\n\n";
                    out +=
                        [
                            "- Execute o espa√ßo como √¢ncora, mas deixe a cena viva e funcional.",
                            "- Voc√™ pode criar micro-eventos e varia√ß√µes de ritmo para come√ßar no impacto (cold open).",
                            "- Continuidade local ao chat √© permitida; reset por novo prompt/chat.",
                            "- N√£o liste IDs/c√≥digos no texto.",
                        ].join("\n") + "\n";
                    return out.trim() + "\n";
                }

                // assets only
                if (hasA) {
                    let out = "MATRIX ‚Äî PROMPT GERADOR (ATIVOS)\n\n";
                    out += "## ATIVOS PRESENTES\n\n";
                    out += describeAssets(selectedAssets);
                    out += "## DIRE√á√ÉO CRIATIVA (liberdade do Gemini)\n\n";
                    out +=
                        [
                            "- Use os ativos como motor da cena e crie o ambiente necess√°rio livremente.",
                            "- Vestu√°rio: marcas premium e bonitas, escolhidas conforme o contexto.",
                            "- N√£o liste IDs/c√≥digos no texto.",
                        ].join("\n") + "\n";
                    return out.trim() + "\n";
                }

                return "";
            }

            async function copyToClipboard(text) {
                // Clipboard API (melhor)
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                    return true;
                }
                // fallback
                const ta = document.createElement("textarea");
                ta.value = text;
                ta.style.position = "fixed";
                ta.style.left = "-9999px";
                document.body.appendChild(ta);
                ta.select();
                const ok = document.execCommand("copy");
                document.body.removeChild(ta);
                return ok;
            }

            function openPreview(prompt) {
                // Preview simples via new window (n√£o intrusivo)
                const w = window.open("", "_blank");
                if (!w) {
                    toast(
                        `<b>Popup bloqueado.</b> Mesmo assim o bot√£o Gerar+Copiar funciona.`,
                    );
                    return;
                }
                w.document.write(
                    `<pre style="white-space:pre-wrap;font-family:ui-monospace, Menlo, Monaco, Consolas, monospace; padding:16px; background:#0b0e14; color:#d7dde8;">${escapeHtml(prompt)}</pre>`,
                );
                w.document.close();
            }

            function escapeHtml(s) {
                return String(s).replace(
                    /[&<>"']/g,
                    (c) =>
                        ({
                            "&": "&amp;",
                            "<": "&lt;",
                            ">": "&gt;",
                            '"': "&quot;",
                            "'": "&#39;",
                        })[c],
                );
            }

            function renderAll() {
                const uBox = $("universes");
                const sBox = $("spaces");
                const aBox = $("assets");
                uBox.innerHTML = "";
                sBox.innerHTML = "";
                aBox.innerHTML = "";

                $("uCount").textContent = `${DATA.universes.length} itens`;
                $("sCount").textContent = `${DATA.spaces.length} itens`;
                $("aCount").textContent = `${DATA.assets.length} itens`;

                // clusters hint
                const hasCluster = DATA.spaces.some(
                    (s) => s.cluster_binding && s.cluster_binding.cluster_id,
                );
                if (hasCluster) {
                    $("clusterHint").style.display = "block";
                    $("clusterHint").textContent =
                        "Clusters aparecem como badge (contrato herdado). Clusters n√£o s√£o execut√°veis.";
                } else {
                    $("clusterHint").style.display = "none";
                }

                // universes
                DATA.universes
                    .slice()
                    .sort((x, y) =>
                        byName(
                            x.name || x.title || "",
                            x.id || x.universe_id || "",
                            y.name || y.title || "",
                            y.id || y.universe_id || "",
                        ),
                    )
                    .forEach((u) => {
                        const uid = u.id || u.universe_id || "";
                        const name = u.name || u.title || "(sem nome)";
                        const row = makeRow({
                            id: uid,
                            name,
                            search: `${uid} ${name}`,
                            selected: uid === selectedUniverseId,
                            onClick: () => selectUniverse(uid),
                        });
                        uBox.appendChild(row);
                    });

                // spaces
                const clusterIndex = buildClusterIndex();
                DATA.spaces
                    .slice()
                    .sort((x, y) =>
                        byName(
                            x.name || x.title || "",
                            x.id || "",
                            y.name || y.title || "",
                            y.id || "",
                        ),
                    )
                    .forEach((s) => {
                        const sid = s.id || "";
                        const name = s.name || "(sem nome)";
                        let b = null;
                        if (s.cluster_binding && s.cluster_binding.cluster_id) {
                            const c = clusterIndex.get(
                                s.cluster_binding.cluster_id,
                            );
                            const label = c?.name
                                ? `C ${c.name}`
                                : `C ${s.cluster_binding.cluster_id}`;
                            b = badge(label, "c");
                        }

                        const row = makeRow({
                            id: sid,
                            name,
                            search: `${sid} ${name}`,
                            extraBadge: b,
                            selected: sid === selectedSpaceId,
                            onClick: () => selectSpace(sid),
                        });
                        sBox.appendChild(row);
                    });

                // assets
                DATA.assets
                    .slice()
                    .sort((x, y) => {
                        const xn =
                            `${x.nome || ""} ${x.sobrenome || ""}`.trim();
                        const yn =
                            `${y.nome || ""} ${y.sobrenome || ""}`.trim();
                        return byName(
                            xn,
                            x.asset_id || x.id || "",
                            yn,
                            y.asset_id || y.id || "",
                        );
                    })
                    .forEach((a) => {
                        const aid = a.asset_id || a.id || "";
                        const full =
                            `${a.nome || ""} ${a.sobrenome || ""}`.trim() ||
                            "(sem nome)";
                        const row = makeRow({
                            id: aid,
                            name: full,
                            search: `${aid} ${full}`,
                            selected: selectedAssetIds.has(aid),
                            onClick: () => toggleAsset(aid),
                        });
                        aBox.appendChild(row);
                    });

                updateSummary();
                applyFilter();
            }

            async function init() {
                try {
                    setStatus("LOADING");
                    showMsg(
                        "",
                        `<b>Carregando</b> assets.json ¬∑ spaces.json ¬∑ universes.json ‚Ä¶`,
                    );

                    const [assetsJSON, spacesJSON, universesJSON] =
                        await Promise.all([
                            loadJSON("./assets.json"),
                            loadJSON("./spaces.json"),
                            loadJSON("./universes.json"),
                        ]);

                    DATA.assets = extractAssets(assetsJSON);
                    DATA.spaces = extractSpaces(spacesJSON);
                    DATA.clusters = extractClusters(spacesJSON);
                    DATA.universes = extractUniverses(universesJSON);

                    if (
                        !DATA.assets.length &&
                        !DATA.spaces.length &&
                        !DATA.universes.length
                    ) {
                        throw new Error(
                            "Nenhum dado carregado (JSONs vazios ou formato inesperado).",
                        );
                    }

                    $("message").style.display = "none";
                    $("dash").style.display = "grid";
                    setStatus("READY");

                    // filter
                    $("filter").addEventListener("input", applyFilter);

                    // buttons
                    $("btnClear").addEventListener("click", clearSelection);

                    $("btnPreview").addEventListener("click", () => {
                        try {
                            const prompt = buildPrompt();
                            if (!prompt) return;
                            lastPrompt = prompt;
                            openPreview(prompt);
                        } catch (e) {
                            toast(
                                `<b>Erro:</b> ${escapeHtml(e.message || String(e))}`,
                            );
                        }
                    });

                    $("btnGenerate").addEventListener("click", async () => {
                        try {
                            const prompt = buildPrompt();
                            if (!prompt) {
                                toast(
                                    `<b>Nada selecionado.</b> Escolha um universo/espa√ßo e/ou ativos.`,
                                );
                                return;
                            }
                            lastPrompt = prompt;
                            const ok = await copyToClipboard(prompt);
                            if (ok)
                                toast(
                                    `<b>Copiado!</b> Agora √© s√≥ colar no Gemini.`,
                                );
                            else
                                toast(
                                    `<b>Falhou ao copiar.</b> Use a pr√©via para copiar manualmente.`,
                                );
                        } catch (e) {
                            toast(
                                `<b>Erro:</b> ${escapeHtml(e.message || String(e))}`,
                            );
                        }
                    });

                    renderAll();
                    toast(
                        `<b>Ready.</b> Selecione 1 item √† esquerda e N ativos √† direita.`,
                    );
                } catch (err) {
                    setStatus("ERROR");
                    showMsg(
                        "error",
                        `<b>Erro ao carregar dados.</b><br><br>
           ${String(err.message || err)}<br><br>
           Confirme que <code>assets.json</code>, <code>spaces.json</code> e <code>universes.json</code> est√£o na raiz do repo e acess√≠veis pelo Pages.`,
                    );
                }
            }

            init();
        </script>
    </body>
</html>
